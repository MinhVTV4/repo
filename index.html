<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia S∆∞ L·∫≠p Tr√¨nh AI - Gemini API</title>
    
    <!-- Th∆∞ vi·ªán Marked.js, Highlight.js v√† GitHub Markdown CSS -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">

    <style>
        /* CSS C∆° B·∫£n & Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f6f8fa; /* M√†u n·ªÅn Github */
            color: #24292f; 
            display: flex;
            height: 100vh; /* S√°t l·ªÅ, full m√†n h√¨nh */
            overflow: hidden;
        }

        /* --- C·ªòT TR√ÅI (SIDEBAR / CONTROLS) --- */
        #sidebar {
            width: 360px;
            background-color: #ffffff;
            border-right: 1px solid #d0d7de;
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #eaeeef;
        }
        .sidebar-header h1 { 
            color: #0969da; 
            font-size: 1.25rem;
            margin-bottom: 5px;
        }
        .sidebar-header h2 {
            font-size: 0.85rem;
            color: #57606a;
            font-weight: normal;
        }

        #controls { 
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung d√†i */
            flex-grow: 1;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #24292f;
        }

        .template-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        .template-btn {
            padding: 10px 15px;
            background-color: #f6f8fa;
            color: #24292f;
            border: 1px solid #d0d7de;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-weight: 500;
        }
        .template-btn:hover {
            background-color: #f3f4f6;
            border-color: #0969da;
            color: #0969da;
        }

        textarea { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #d0d7de; 
            border-radius: 6px; 
            resize: vertical;
            font-size: 14px;
            font-family: inherit;
            min-height: 120px;
            background-color: #f6f8fa;
        }
        textarea:focus {
            outline: none;
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9,105,218,0.3);
            background-color: #fff;
        }

        button#sendPromptButton { 
            padding: 12px; 
            background-color: #2da44e; /* M√†u xanh Github action */
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 15px;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        button#sendPromptButton:hover { background-color: #2c974b; }
        button#sendPromptButton:disabled { background-color: #94d3a2; cursor: not-allowed; }

        /* --- L·ªäCH S·ª¨ B√ÄI H·ªåC (INDEXEDDB) --- */
        #historyList {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .history-item {
            padding: 10px;
            background-color: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .history-item:hover {
            background-color: #f3f4f6;
            border-color: #0969da;
        }
        .history-title {
            font-weight: 600;
            color: #24292f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            margin-bottom: 4px;
        }
        .history-date {
            font-size: 11px;
            color: #57606a;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #cf222e;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0.6;
            transition: all 0.2s;
        }
        .delete-btn:hover { background-color: #ffebe9; opacity: 1; }

        .save-btn {
            padding: 8px 16px;
            background-color: #2da44e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }
        .save-btn:hover { background-color: #2c974b; }

        /* --- TR·∫†NG TH√ÅI (STATUS) --- */
        .status-message {
            margin-top: 15px;
            font-size: 0.85rem;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            line-height: 1.4;
        }
        .status-message.error-text { background-color: #ffebe9; color: #cf222e; }
        .status-message.success-text { background-color: #dafbe1; color: #1a7f37; }
        .status-message.info-text { background-color: #ddf4ff; color: #0969da; }

        /* --- C·ªòT PH·∫¢I (MAIN CONTENT) --- */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }
        
        #responseContainer { 
            padding: 40px; 
            background-color: #fff; 
            min-height: 100%; 
            width: 100%;
            max-width: 900px;
            margin: 0 auto; /* CƒÉn gi·ªØa n·ªôi dung vƒÉn b·∫£n */
            box-shadow: 0 0 15px rgba(0,0,0,0.03);
            transition: opacity 0.3s ease;
        }
        #responseContainer.loading {
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #57606a;
        }

        .placeholder-text {
            color: #57606a;
            font-size: 1.1rem;
            text-align: center;
            margin-top: 20%;
        }

        /* --- SPINNER --- */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .large-spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
            border-left-color: #0969da;
            border-color: rgba(9, 105, 218, 0.2);
            border-left-color: #0969da;
            margin-bottom: 15px;
        }
        .hidden { display: none !important; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- CUSTOM MODALS (POPUP) --- */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .custom-modal-overlay.show {
            opacity: 1; visibility: visible;
        }
        .custom-modal {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            width: 90%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: transform 0.2s;
        }
        .custom-modal-overlay.show .custom-modal {
            transform: translateY(0);
        }
        .custom-modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; color: #24292f; }
        .custom-modal-input { width: 100%; padding: 10px; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
        .custom-modal-input:focus { outline: none; border-color: #0969da; }
        .custom-modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; }
        .modal-btn-cancel { background: #f6f8fa; color: #24292f; border: 1px solid #d0d7de; }
        .modal-btn-cancel:hover { background: #eaeeef; }
        .modal-btn-danger { background: #cf222e; color: white; }
        .modal-btn-danger:hover { background: #a40e26; }
        .modal-btn-primary { background: #2da44e; color: white; }
        .modal-btn-primary:hover { background: #2c974b; }

        /* --- NH·∫¨T K√ù H·ªåC T·∫¨P (SESSION LOGS) --- */
        .log-block {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #eaeeef;
        }
        .log-prompt {
            background-color: #f6f8fa;
            padding: 12px 16px;
            border-radius: 8px 8px 8px 0;
            border-left: 4px solid #0969da;
            color: #24292f;
            font-weight: 500;
            margin-bottom: 15px;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .log-response {
            /* K·∫ø th·ª´a markdown-body */
        }
        .loading-block {
            display: flex; align-items: center; gap: 10px; color: #57606a; margin-top: 20px;
        }

        /* --- QUICK ACTIONS (THAO T√ÅC NHANH) --- */
        #quickActions {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eaeeef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .quick-btn {
            padding: 8px 16px; border-radius: 20px; font-size: 13.5px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s; border: none;
        }
        .quick-btn-next { background-color: #0969da; color: white; }
        .quick-btn-next:hover { background-color: #0550ae; transform: translateX(2px); }
        .quick-btn-bug { background-color: #f6f8fa; color: #24292f; border: 1px solid #d0d7de; }
        .quick-btn-bug:hover { background-color: #eaeeef; }

        /* --- AUTH INFO HEADER --- */
        .user-info {
            font-size: 13px; color: #57606a; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; background: #f6f8fa; padding: 6px 10px; border-radius: 6px; border: 1px solid #d0d7de;
        }
        .logout-btn {
            background: #fff; border: 1px solid #d0d7de; font-size: 12px; padding: 4px 8px; border-radius: 4px; cursor: pointer; color: #cf222e; font-weight: 500; transition: all 0.2s;
        }
        .logout-btn:hover { background: #ffebe9; border-color: #cf222e; }

        /* --- MOBILE RESPONSIVE (SIDEBAR TR∆Ø·ª¢T) --- */
        .mobile-header {
            display: none;
            align-items: center;
            background-color: #24292f;
            color: #fff;
            padding: 12px 20px;
            z-index: 101;
        }
        .mobile-header h1 {
            font-size: 1.1rem;
            margin-left: 15px;
            font-weight: 600;
        }
        .hamburger-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        #sidebarOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s;
        }

        @media (max-width: 850px) {
            body { flex-direction: column; }
            .mobile-header { display: flex; }
            
            #sidebar {
                position: fixed;
                top: 0; bottom: 0; left: 0;
                width: 320px;
                transform: translateX(-100%);
                box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            }
            #sidebar.open { transform: translateX(0); }
            
            #sidebarOverlay.show {
                display: block;
                opacity: 1;
            }

            .sidebar-header { display: none; /* ·∫®n header tr√°i tr√™n mobile do ƒë√£ c√≥ thanh ƒëen tr√™n c√πng */ }
            
            #main-content {
                height: calc(100vh - 53px); /* Tr·ª´ ƒëi height c·ªßa mobile header */
            }
            #responseContainer { padding: 20px; }
            .placeholder-text { margin-top: 30%; font-size: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Header d√†nh ri√™ng cho Mobile -->
    <div class="mobile-header">
        <button class="hamburger-btn" id="menuToggle">‚ò∞</button>
        <h1>Gia S∆∞ L·∫≠p Tr√¨nh AI</h1>
    </div>

    <!-- L·ªõp ph·ªß m√†n m·ªù tr√™n Mobile khi m·ªü Sidebar -->
    <div id="sidebarOverlay"></div>

    <!-- C·ªòT TR√ÅI: Thanh c√¥ng c·ª• -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>Gia S∆∞ L·∫≠p Tr√¨nh AI</h1>
            <h2>M√¥ h√¨nh: gemini-2.5-flash</h2>
            
            <!-- V√πng hi·ªÉn th·ªã th√¥ng tin t√†i kho·∫£n -->
            <div id="userInfoDisplay" class="user-info hidden">
                <span id="userEmail" style="overflow: hidden; text-overflow: ellipsis; max-width: 150px; white-space: nowrap;" title="Email"></span>
                <button class="logout-btn" onclick="logoutUser()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        
        <div id="controls">
            <div class="section-title">Khung m·∫´u (Templates)</div>
            <div class="template-buttons">
                <button class="template-btn" onclick="setTemplate('explain')">üìñ 1. Gi·∫£i th√≠ch Repo (Nh·∫≠p m√¥n)</button>
                <button class="template-btn" onclick="setTemplate('tutor')">üéì 2. D·∫°y t·ª´ng b∆∞·ªõc (Th·ª±c h√†nh)</button>
                <button class="template-btn" onclick="setTemplate('debug')">üêõ 3. S·ª≠a l·ªói (Debug Terminal)</button>
                <button class="template-btn" onclick="setTemplate('customize')">üõ†Ô∏è 4. T√πy ch·ªânh Project</button>
                <button class="template-btn" onclick="setTemplate('deploy')">üöÄ 5. H∆∞·ªõng d·∫´n Tri·ªÉn khai</button>
            </div>
            
            <div class="section-title">L·ªùi nh·∫Øc (Prompt)</div>
            
            <div id="repoContextBadge" class="hidden" style="font-size: 12px; color: #1a7f37; background-color: #dafbe1; padding: 8px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #a3e4b5; display: flex; justify-content: space-between; align-items: center;">
                <span>üìå ƒê√£ ghi nh·ªõ c·∫•u tr√∫c d·ª± √°n. (S·∫µn s√†ng d·∫°y t·ª´ng b∆∞·ªõc)</span>
                <button onclick="clearRepoIndex()" style="background: none; border: none; color: #cf222e; cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1;" title="X√≥a ghi nh·ªõ">√ó</button>
            </div>
            
            <textarea id="promptInput" placeholder="Nh·∫•p v√†o c√°c m·∫´u b√™n tr√™n ho·∫∑c t·ª± d√°n link GitHub / nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            
            <button id="sendPromptButton">
                <span id="buttonText">G·ª≠i t·ªõi Gemini</span>
                <div id="buttonSpinner" class="spinner hidden"></div>
            </button>
            
            <p id="statusMessage" class="status-message"></p>

            <hr style="border: 0; border-top: 1px solid #d0d7de; margin: 20px 0;">
            
            <div class="section-title">C√°c d·ª± √°n ƒë√£ h·ªçc</div>
            <div id="historyList">
                <div style="font-size: 13px; color: #57606a;">Ch∆∞a c√≥ d·ª± √°n n√†o.</div>
            </div>
        </div>
    </div>
    
    <!-- C·ªòT PH·∫¢I: Khung hi·ªÉn th·ªã n·ªôi dung -->
    <div id="main-content">
        <div id="responseContainer" class="markdown-body">
            <!-- X√ìA N√öT L∆ØU TH·ª¶ C√îNG, THAY B·∫∞NG CONTAINER CH·ª®A L·ªäCH S·ª¨ -->
            <div id="chatHistoryContainer">
                <div class="placeholder-text">
                    Xin ch√†o! <br><br>H√£y d√°n m·ªôt ƒë∆∞·ªùng d·∫´n GitHub ho·∫∑c nh·∫≠p l·ªùi nh·∫Øc ·ªü c·ªôt b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu bu·ªïi h·ªçc.
                </div>
            </div>
            
            <div id="loadingIndicator" class="loading-block hidden">
                <div class="spinner" style="border-left-color: #0969da; border-width: 3px;"></div> ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...
            </div>
            
            <!-- Thanh thao t√°c nhanh (M·∫∑c ƒë·ªãnh ·∫©n) -->
            <div id="quickActions" class="hidden">
                <button id="btnNextStep" class="quick-btn quick-btn-next">Ti·∫øp t·ª•c b∆∞·ªõc ti·∫øp theo ‚û°Ô∏è</button>
                <button id="btnGotBug" class="quick-btn quick-btn-bug">T√¥i g·∫∑p l·ªói ·ªü b∆∞·ªõc n√†y üêõ</button>
            </div>
        </div>
    </div>

    <!-- HTML C√ÅC MODALS -->
    <!-- Modal X√°c nh·∫≠n (Confirm) -->
    <div id="confirmModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="custom-modal-title" id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn?</div>
            <div class="custom-modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('confirmModal')">H·ªßy</button>
                <button class="modal-btn modal-btn-danger" id="confirmYesBtn">X√≥a</button>
            </div>
        </div>
    </div>

    <!-- Modal Nh·∫≠p li·ªáu (Prompt) -->
    <div id="promptModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="custom-modal-title" id="promptTitle">Nh·∫≠p th√¥ng tin</div>
            <input type="text" id="promptInputVal" class="custom-modal-input" autocomplete="off">
            <div class="custom-modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('promptModal')">H·ªßy</button>
                <button class="modal-btn modal-btn-primary" id="promptYesBtn">L∆∞u b√†i</button>
            </div>
        </div>
    </div>

    <!-- Modal ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω -->
    <div id="authModal" class="custom-modal-overlay show">
        <div class="custom-modal">
            <div class="custom-modal-title">ƒêƒÉng nh·∫≠p ƒê√°m M√¢y</div>
            <div style="font-size: 13.5px; color: #57606a; margin-bottom: 15px; line-height: 1.4;">ƒêƒÉng nh·∫≠p ƒë·ªÉ t·ª± ƒë·ªông l∆∞u v√† ƒë·ªìng b·ªô l·ªãch s·ª≠ b√†i h·ªçc c·ªßa b·∫°n tr√™n m√°y ch·ªß (Firestore).</div>
            <div id="authError" style="color: #cf222e; font-size: 13px; margin-bottom: 10px; font-weight: 500;"></div>
            <input type="email" id="authEmail" class="custom-modal-input" placeholder="Email c·ªßa b·∫°n (VD: user@email.com)">
            <input type="password" id="authPassword" class="custom-modal-input" placeholder="M·∫≠t kh·∫©u (√çt nh·∫•t 6 k√Ω t·ª±)">
            <div class="custom-modal-actions" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-cancel" onclick="registerUser()">ƒêƒÉng k√Ω m·ªõi</button>
                <button class="modal-btn modal-btn-primary" onclick="loginUser()">ƒêƒÉng nh·∫≠p</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- B·∫ÆT ƒê·∫¶U: S·ª¨A L·ªñI AbortSignal.any ---
        // Polyfill cho AbortSignal.any nh·∫±m h·ªó tr·ª£ c√°c tr√¨nh duy·ªát/m√¥i tr∆∞·ªùng thi·∫øu h√†m n√†y
        // (ƒê√¢y l√† nguy√™n nh√¢n g√¢y ra l·ªói "AbortSignal.any is not a function" tr√™n Firebase SDK 12.9.0)
        if (typeof AbortSignal !== 'undefined' && !AbortSignal.any) {
            AbortSignal.any = function(signals) {
                const controller = new AbortController();
                for (const signal of signals) {
                    if (signal.aborted) {
                        controller.abort(signal.reason);
                        return controller.signal;
                    }
                    signal.addEventListener('abort', () => controller.abort(signal.reason), { once: true });
                }
                return controller.signal;
            };
        }
        // --- K·∫æT TH√öC: S·ª¨A L·ªñI AbortSignal.any ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-ai.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAtoX3PysX692bNg6nA55Qriv5P-7phmFQ",
          authDomain: "aiminh-d96d4.firebaseapp.com",
          projectId: "aiminh-d96d4",
          storageBucket: "aiminh-d96d4.firebasestorage.app",
          messagingSenderId: "159603803322",
          appId: "1:159603803322:web:3693589412fca5c3456e83"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        console.log("Firebase & Firestore App initialized!");
        
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        // --- C√ÅC BI·∫æN & LOGIC H·ªÜ TH·ªêNG ---
        let currentRepoId = null; 
        let sessionHistory = []; 
        let currentRepoIndex = ""; 
        let activeTemplateType = "custom"; 

        window.clearRepoIndex = function() {
            currentRepoId = null;
            currentRepoIndex = "";
            sessionHistory = [];
            document.getElementById('repoContextBadge').classList.add('hidden');
            document.getElementById('quickActions').classList.add('hidden');
            document.getElementById('chatHistoryContainer').innerHTML = `
                <div class="placeholder-text">ƒê√£ t·∫°o phi√™n h·ªçc m·ªõi.<br><br>H√£y d√°n link d·ª± √°n m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
            `;
            updateStatus('info-text', "ƒê√£ t·∫°o phi√™n h·ªçc m·ªõi.");
        };

        const chatHistoryContainer = document.getElementById('chatHistoryContainer');
        const historyList = document.getElementById('historyList');
        const quickActions = document.getElementById('quickActions');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // --- LOGIC AUTH (ƒêƒÇNG NH·∫¨P / ƒêƒÇNG K√ù) ---
        const authModal = document.getElementById('authModal');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authError = document.getElementById('authError');
        const userInfoDisplay = document.getElementById('userInfoDisplay');
        const userEmailSpan = document.getElementById('userEmail');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authModal.classList.remove('show');
                userInfoDisplay.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                updateStatus('info-text', "ƒê√£ k·∫øt n·ªëi ƒë√°m m√¢y. ƒêang t·∫£i d·ªØ li·ªáu...");
                loadHistory(); 
            } else {
                authModal.classList.add('show');
                userInfoDisplay.classList.add('hidden');
                historyList.innerHTML = '<div style="font-size: 13px; color: #57606a;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠.</div>';
                clearRepoIndex(); 
            }
        });

        window.loginUser = async function() {
            try {
                authError.textContent = "ƒêang ƒëƒÉng nh·∫≠p...";
                await signInWithEmailAndPassword(auth, authEmail.value, authPassword.value);
            } catch (error) {
                authError.textContent = "L·ªói ƒëƒÉng nh·∫≠p: " + error.message;
            }
        };

        window.registerUser = async function() {
            try {
                authError.textContent = "ƒêang t·∫°o t√†i kho·∫£n...";
                await createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value);
            } catch (error) {
                authError.textContent = "L·ªói ƒëƒÉng k√Ω: " + error.message;
            }
        };

        window.logoutUser = async function() {
            await signOut(auth);
        };

        // --- LOGIC CUSTOM MODAL ---
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showCustomConfirm(message, onConfirm) {
            document.getElementById('confirmMessage').innerText = message;
            const overlay = document.getElementById('confirmModal');
            const yesBtn = document.getElementById('confirmYesBtn');
            
            overlay.classList.add('show');
            yesBtn.onclick = function() {
                closeModal('confirmModal');
                onConfirm();
            };
        }

        function showCustomPrompt(title, defaultVal, onConfirm) {
            document.getElementById('promptTitle').innerText = title;
            const inputField = document.getElementById('promptInputVal');
            const overlay = document.getElementById('promptModal');
            const yesBtn = document.getElementById('promptYesBtn');
            
            inputField.value = defaultVal;
            overlay.classList.add('show');
            inputField.focus();
            
            yesBtn.onclick = function() {
                closeModal('promptModal');
                onConfirm(inputField.value);
            };
            
            inputField.onkeydown = function(e) {
                if (e.key === 'Enter') yesBtn.click();
            }
        }

        // --- LOGIC L∆ØU TR·ªÆ L√äN ƒê√ÅM M√ÇY (FIRESTORE) ---
        let currentUserRepos = [];

        async function loadHistory() {
            if (!auth.currentUser) return;
            const q = query(collection(db, `users/${auth.currentUser.uid}/repos`), orderBy("updatedAt", "desc"));
            try {
                const querySnapshot = await getDocs(q);
                currentUserRepos = [];
                historyList.innerHTML = "";
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<div style="font-size: 13px; color: #57606a;">Ch∆∞a c√≥ d·ª± √°n n√†o ƒë∆∞·ª£c h·ªçc tr√™n ƒë√°m m√¢y.</div>';
                    return;
                }
                
                querySnapshot.forEach(docSnap => {
                    const repo = { id: docSnap.id, ...docSnap.data() };
                    currentUserRepos.push(repo);
                    
                    const dateStr = new Date(repo.updatedAt).toLocaleString('vi-VN');
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div style="overflow: hidden; flex-grow: 1;" onclick="viewRepo('${repo.id}')">
                            <div class="history-title">${repo.title}</div>
                            <div class="history-date">${repo.history.length} b√†i gi·∫£ng ‚Ä¢ ${dateStr}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteRepo('${repo.id}', event)" title="X√≥a d·ª± √°n n√†y">üóëÔ∏è</button>
                    `;
                    historyList.appendChild(item);
                });
            } catch (error) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu t·ª´ Firestore:", error);
                updateStatus('error-text', "L·ªói t·∫£i d·ªØ li·ªáu Firestore. Vui l√≤ng ki·ªÉm tra l·∫°i quy·ªÅn (Rules).");
            }
        }

        window.viewRepo = function(id) {
            const repo = currentUserRepos.find(r => r.id === id);
            if(repo) {
                currentRepoId = repo.id;
                currentRepoIndex = repo.repoIndex || "";
                sessionHistory = repo.history || [];
                
                renderChatHistory(); 
                
                if (currentRepoIndex !== "") {
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }
                quickActions.classList.remove('hidden');
                updateStatus('info-text', `ƒêang ti·∫øp t·ª•c h·ªçc d·ª± √°n: ${repo.title}`);
                
                if(window.innerWidth <= 850 && document.getElementById('sidebar').classList.contains('open')) {
                    document.getElementById('sidebar').classList.remove('open');
                    document.getElementById('sidebarOverlay').classList.remove('show');
                }
            }
        };

        window.deleteRepo = function(id, event) {
            event.stopPropagation();
            showCustomConfirm("X√≥a to√†n b·ªô ti·∫øn tr√¨nh h·ªçc c·ªßa d·ª± √°n n√†y tr√™n ƒë√°m m√¢y?", async () => {
                try {
                    await deleteDoc(doc(db, `users/${auth.currentUser.uid}/repos`, id));
                    if (currentRepoId === id) clearRepoIndex(); 
                    loadHistory();
                    updateStatus('success-text', "ƒê√£ x√≥a d·ª± √°n tr√™n ƒë√°m m√¢y.");
                } catch (error) {
                    alert("L·ªói khi x√≥a: " + error.message);
                }
            });
        };

        async function autoSaveRepo() {
            if (!auth.currentUser || sessionHistory.length === 0) return;
            
            const reposRef = collection(db, `users/${auth.currentUser.uid}/repos`);

            if (currentRepoId === null) {
                let defaultTitle = "D·ª± √°n: " + sessionHistory[0].prompt.split('\n')[0].substring(0, 30) + "...";
                showCustomPrompt("ƒê·∫∑t t√™n d·ª± √°n ƒë·ªÉ l∆∞u l√™n ƒë√°m m√¢y:", defaultTitle, async (title) => {
                    if (title.trim() === "") title = defaultTitle;
                    
                    const newRepoRef = doc(reposRef);
                    currentRepoId = newRepoRef.id; 
                    
                    await setDoc(newRepoRef, {
                        title: title,
                        repoIndex: currentRepoIndex,
                        history: sessionHistory,
                        updatedAt: new Date().getTime()
                    });
                    loadHistory();
                });
            } else {
                const repoRef = doc(db, `users/${auth.currentUser.uid}/repos`, currentRepoId);
                await setDoc(repoRef, {
                    repoIndex: currentRepoIndex,
                    history: sessionHistory,
                    updatedAt: new Date().getTime()
                }, { merge: true }); 
                loadHistory();
            }
        }

        // H√†m v·∫Ω to√†n b·ªô l·ªãch s·ª≠ ra m√†n h√¨nh
        function renderChatHistory() {
            chatHistoryContainer.innerHTML = "";
            sessionHistory.forEach(item => {
                const block = document.createElement('div');
                block.className = 'log-block';
                block.innerHTML = `
                    <div class="log-prompt">üôã‚Äç‚ôÇÔ∏è ${item.prompt}</div>
                    <div class="log-response markdown-body">${marked.parse(item.response)}</div>
                `;
                chatHistoryContainer.appendChild(block);
            });
            // Cu·ªôn xu·ªëng cu·ªëi
            document.getElementById('main-content').scrollTop = document.getElementById('main-content').scrollHeight;
        }

        // Logic thao t√°c nhanh (Quick Actions)
        document.getElementById('btnNextStep').addEventListener('click', () => {
            promptInput.value = "T√¥i ƒë√£ ho√†n th√†nh b∆∞·ªõc v·ª´a r·ªìi. H√£y ti·∫øp t·ª•c h∆∞·ªõng d·∫´n t√¥i b∆∞·ªõc ti·∫øp theo.";
            sendPromptButton.click();
        });

        document.getElementById('btnGotBug').addEventListener('click', () => {
            promptInput.value = "T√¥i g·∫∑p l·ªói ·ªü b∆∞·ªõc n√†y. L√Ω do c√≥ th·ªÉ l√† g√¨ v√† l√†m sao ƒë·ªÉ ki·ªÉm tra/kh·∫Øc ph·ª•c? ƒê√¢y l√† m√£ l·ªói t√¥i th·∫•y:\n[D√ÅN M√É L·ªñI V√ÄO ƒê√ÇY]";
            promptInput.focus();
            // N·∫øu tr√™n Mobile, t·ª± m·ªü l·∫°i sidebar ƒë·ªÉ g√µ l·ªói
            if(window.innerWidth <= 850 && !document.getElementById('sidebar').classList.contains('open')) {
                toggleSidebar();
            }
        });

        // Logic ·∫©n hi·ªán Sidebar cho Mobile
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        function updateStatus(type, message) {
            statusMessage.className = `status-message ${type}`;
            statusMessage.textContent = message;
            if (type === 'info-text') {
                statusMessage.innerHTML = message; // Cho ph√©p th·∫ª <br> ho·∫°t ƒë·ªông
            }
        }

        updateStatus('info-text', "Firebase App ƒë√£ kh·ªüi t·∫°o.<br>ƒêang ch·ªù m√¥ h√¨nh AI...");

        // C·∫•u h√¨nh Marked.js t√≠ch h·ª£p v·ªõi Highlight.js ƒë·ªÉ t√¥ m√†u code
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        const systemPrompt = `You are an AI Technical Tutor.

Your task is to turn any GitHub repository into a complete, beginner-friendly tutorial.

Assume the user is a beginner developer.
Never skip steps.
Never assume prior knowledge.

For every repository, always follow this structure:

1. Explain what problem this repository solves.
2. Explain the big picture architecture.
3. Show the file structure and which file to start with.
4. Explain the execution flow from input to output.
5. Give step-by-step terminal commands to run locally.
6. Explain each command and what it does.
7. Explain how to modify or extend the project.
8. Explain how to deploy (if applicable).

Rules:
- Use simple language.
- Explain before showing code.
- When showing code, explain what each part does.
- Never say "just run this".
- Teach like a real instructor, not like a chatbot.`;

        let model;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { 
                model: "gemini-2.5-flash",
                systemInstruction: systemPrompt
            });
            console.log("Generative Model instance created with model 'gemini-2.5-flash' and System Instruction!");
            updateStatus('success-text', "AI Tutor ƒë√£ s·∫µn s√†ng. H√£y ch·ªçn m·ªôt m·∫´u b√™n tr√™n.");
        } catch (e) {
            console.error("L·ªói khi kh·ªüi t·∫°o AI Model:", e);
            updateStatus('error-text', `L·ªói kh·ªüi t·∫°o AI Model: ${e.message}.<br>Ki·ªÉm tra Console (F12).`);
        }

        const templates = {
            explain: "H√£y ƒë√≥ng vai m·ªôt chuy√™n gia l·∫≠p tr√¨nh. ƒê·ªçc repository d∆∞·ªõi ƒë√¢y v√† t·∫°o ra m·ªôt b·∫£n t√≥m t·∫Øt ki·∫øn tr√∫c d·ª± √°n, lu·ªìng ho·∫°t ƒë·ªông ch√≠nh v√† c√°c file quan tr·ªçng. Gi·∫£i th√≠ch cho t√¥i hi·ªÉu nh∆∞ m·ªôt ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu.\n\n[D√ÅN LINK GITHUB HO·∫∂C M√É NGU·ªíN V√ÄO ƒê√ÇY]",
            tutor: "B√¢y gi·ªù h√£y d·∫°y t√¥i th·ª±c h√†nh d·ª± √°n tr√™n t·ª´ng b∆∞·ªõc m·ªôt.\nSau m·ªói b∆∞·ªõc, h√£y ƒë·ª£i t√¥i x√°c nh·∫≠n tr∆∞·ªõc khi ti·∫øp t·ª•c.\nN·∫øu t√¥i g·∫∑p l·ªói, h√£y gi√∫p t√¥i s·ª≠a (debug).",
            debug: "T√¥i nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o l·ªói n√†y trong qu√° tr√¨nh l√†m. H√£y gi·∫£i th√≠ch b·∫±ng ng√¥n ng·ªØ ƒë∆°n gi·∫£n t·∫°i sao l·∫°i b·ªã l·ªói v√† c√°ch kh·∫Øc ph·ª•c.\n[D√ÅN LOG L·ªñI V√ÄO ƒê√ÇY]",
            customize: "T√¥i mu·ªën t√πy ch·ªânh d·ª± √°n n√†y cho m·ª•c ƒë√≠ch c√° nh√¢n c·ªßa m√¨nh:\n[ƒêI·ªÄN M·ª§C TI√äU C·ª¶A B·∫†N V√ÄO ƒê√ÇY]\n\nH√£y gi·∫£i th√≠ch nh·ªØng g√¨ t√¥i c·∫ßn thay ƒë·ªïi trong m√£ ngu·ªìn.",
            deploy: "H√£y h∆∞·ªõng d·∫´n t√¥i c√°ch tri·ªÉn khai (deploy) d·ª± √°n n√†y l√™n m·∫°ng.\nC·ª© gi·∫£ ƒë·ªãnh r·∫±ng t√¥i ch∆∞a t·ª´ng deploy b·∫•t c·ª© th·ª© g√¨ tr∆∞·ªõc ƒë√¢y.\nH√£y gi·∫£i th√≠ch c·∫∑n k·∫Ω t·ª´ng b∆∞·ªõc."
        };

        window.setTemplate = function(type) {
            activeTemplateType = type; 
            promptInput.value = templates[type];
            promptInput.focus();
            
            if(window.innerWidth <= 850 && sidebar.classList.contains('open')) {
                // toggleSidebar(); 
            }
        };

        async function callGeminiAPI() {
            if (!model) {
                updateStatus('error-text', "M√¥ h√¨nh AI ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o. Vui l√≤ng th·ª≠ t·∫£i l·∫°i trang.");
                return;
            }

            const promptText = promptInput.value.trim();
            if (!promptText) {
                updateStatus('error-text', "Vui l√≤ng nh·∫≠p l·ªùi nh·∫Øc ho·∫∑c d√°n link tr∆∞·ªõc!");
                return;
            }

            updateStatus('info-text', "ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn Gemini...");
            
            // Hi·ªán loading indicator b√™n d∆∞·ªõi c√πng
            quickActions.classList.add('hidden');
            if (sessionHistory.length === 0) chatHistoryContainer.innerHTML = ""; // X√≥a d√≤ng ch√†o m·ª´ng
            loadingIndicator.classList.remove('hidden');

            buttonText.textContent = 'ƒêang x·ª≠ l√Ω...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            if(window.innerWidth <= 850 && sidebar.classList.contains('open')) {
                toggleSidebar();
            }

            let finalPrompt = promptText;
            if (currentRepoIndex !== "" && activeTemplateType !== 'explain') {
                finalPrompt = `[NG·ªÆ C·∫¢NH D·ª∞ √ÅN T·ª™ PAGE INDEX ƒê√É L∆ØU]:\n${currentRepoIndex}\n\n`;
                
                // L·∫•y c√¢u tr·∫£ l·ªùi cu·ªëi c√πng ƒë·ªÉ l√†m ng·ªØ c·∫£nh
                if (sessionHistory.length > 0) {
                    finalPrompt += `[B∆Ø·ªöC B·∫†N V·ª™A H∆Ø·ªöNG D·∫™N ·ªû TR∆Ø·ªöC ƒê√ì]:\n${sessionHistory[sessionHistory.length - 1].response}\n\n`;
                }

                finalPrompt += `---\n[Y√äU C·∫¶U M·ªöI C·ª¶A T√îI]:\n${promptText}`;
            }

            try {
                const result = await model.generateContent(finalPrompt);
                const response = result.response;
                const text = response.text();

                if (activeTemplateType === 'explain') {
                    currentRepoIndex = text;
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }

                // Push v√†o m·∫£ng l·ªãch s·ª≠ phi√™n
                sessionHistory.push({
                    prompt: promptText,
                    response: text
                });

                // X√≥a input sau khi g·ª≠i th√†nh c√¥ng
                promptInput.value = "";

                // V·∫Ω l·∫°i giao di·ªán v√† t·ª± ƒë·ªông l∆∞u
                loadingIndicator.classList.add('hidden');
                renderChatHistory();
                autoSaveRepo();
                
                if (activeTemplateType === 'explain') {
                    updateStatus('success-text', "ƒê√£ nh·∫≠n ph·∫£n h·ªìi. üìå H·ªá th·ªëng ƒë√£ t·ª± ƒë·ªông l∆∞u d·ª± √°n!");
                } else {
                    updateStatus('success-text', "ƒê√£ l∆∞u ti·∫øp ti·∫øn tr√¨nh h·ªçc.");
                }

                activeTemplateType = "custom";
                quickActions.classList.remove('hidden');

            } catch (error) {
                console.error("L·ªói khi g·ªçi Gemini API:", error);
                loadingIndicator.classList.add('hidden');
                updateStatus('error-text', `L·ªói: ${error.message}.`);
                alert("L·ªói khi g·ªçi API: " + error.message);
            } finally {
                buttonText.textContent = 'G·ª≠i t·ªõi Gemini';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
            }
        }

        if (sendPromptButton) {
            sendPromptButton.addEventListener("click", callGeminiAPI);
        }
    </script>
</body>
</html>
