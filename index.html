<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Gia S∆∞ L·∫≠p Tr√¨nh AI - Material Design 3</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Roboto"', 'sans-serif'],
                        display: ['"Google Sans"', 'sans-serif'],
                    },
                    colors: {
                        primary: "#1a73e8", 
                        "primary-hover": "#1557b0",
                        "background-light": "#f8f9fa",
                        "surface-light": "#ffffff",
                    }
                },
            },
        };
    </script>

    <!-- Th∆∞ vi·ªán Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">

    <!-- CSS b·ªï sung cho Scrollbar, Animation v√† Override Markdown -->
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #bdc1c6; }
        
        .markdown-body { background: transparent !important; font-family: inherit !important; }
        
        /* Tinh ch·ªânh l·∫°i hi·ªÉn th·ªã c·ªßa Inline Code v√† Code Block tr√°nh l·ªói n·ªÅn ƒëen ch·ªØ ƒëen */
        .markdown-body p code, .markdown-body li code, .markdown-body a code {
            background-color: #f1f5f9 !important;
            color: #e11d48 !important; /* M√†u ƒë·ªè ƒë√¥ n·ªïi b·∫≠t tr√™n n·ªÅn s√°ng */
            padding: 0.2rem 0.4rem !important;
            border-radius: 0.375rem !important;
            font-size: 0.875em !important;
        }
        .markdown-body pre { background-color: transparent !important; padding: 0 !important; }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%;
            width: 18px; height: 18px; animation: spin 1s linear infinite;
        }
        .large-spinner {
            width: 32px; height: 32px; border-width: 3px; border-color: rgba(26, 115, 232, 0.2);
            border-left-color: #1a73e8; margin: 0;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Custom Modal Transition */
        .custom-modal-overlay {
            opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s;
        }
        .custom-modal-overlay.show { opacity: 1; visibility: visible; }
        .custom-modal { transform: translateY(-20px); transition: transform 0.2s; }
        .custom-modal-overlay.show .custom-modal { transform: translateY(0); }
        
        /* Sidebar transition cho Mobile */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (max-width: 768px) {
            #sidebar { position: fixed; transform: translateX(-100%); z-index: 50; }
            #sidebar.open { transform: translateX(0); }
        }

        /* N√∫t Cu·ªôn L√™n ƒê·∫ßu Trang */
        .show-scroll-btn {
            opacity: 1 !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
        }
    </style>
</head>
<body class="bg-background-light text-gray-800 font-sans h-screen flex overflow-hidden selection:bg-primary selection:text-white relative">

    <!-- Sidebar Overlay (Mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-gray-900/50 z-40 hidden opacity-0 transition-opacity"></div>

    <!-- C·ªòT TR√ÅI (SIDEBAR) -->
    <aside id="sidebar" class="w-80 md:w-96 flex flex-col border-r border-gray-200 bg-surface-light shadow-sm h-full flex-shrink-0">
        <div class="p-5 pb-2 border-b border-transparent">
            <h1 class="font-display text-2xl font-medium text-primary flex items-center gap-2">
                <span class="material-symbols-rounded text-3xl">school</span> Gia S∆∞ L·∫≠p Tr√¨nh AI
            </h1>
            <div class="flex items-center gap-2 mt-2 px-1">
                <span class="material-symbols-rounded text-sm text-green-600">bolt</span>
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">M√¥ h√¨nh: gemini-2.5-flash</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 py-4 space-y-6">
            <!-- Khung M·∫´u -->
            <section>
                <div class="flex items-center justify-between mb-3 px-1">
                    <h2 class="text-sm font-medium text-gray-600">Khung m·∫´u (Templates)</h2>
                    <span class="material-symbols-rounded text-gray-400 text-lg cursor-pointer hover:text-primary">info</span>
                </div>
                <div class="space-y-2">
                    <button onclick="setTemplate('explain')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">menu_book</span>
                        <span class="text-sm font-medium text-gray-700">1. Gi·∫£i th√≠ch Repo (Nh·∫≠p m√¥n)</span>
                    </button>
                    <button onclick="setTemplate('tutor')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">steps</span>
                        <span class="text-sm font-medium text-gray-700">2. D·∫°y t·ª´ng b∆∞·ªõc (Th·ª±c h√†nh)</span>
                    </button>
                    <button onclick="setTemplate('debug')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">bug_report</span>
                        <span class="text-sm font-medium text-gray-700">3. S·ª≠a l·ªói (Debug Terminal)</span>
                    </button>
                    <button onclick="setTemplate('customize')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">tune</span>
                        <span class="text-sm font-medium text-gray-700">4. T√πy ch·ªânh Project</span>
                    </button>
                    <button onclick="setTemplate('deploy')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">rocket_launch</span>
                        <span class="text-sm font-medium text-gray-700">5. H∆∞·ªõng d·∫´n Tri·ªÉn khai</span>
                    </button>
                </div>
            </section>

            <!-- L·ªùi nh·∫Øc -->
            <section class="flex flex-col gap-3">
                <label class="text-sm font-medium text-gray-600 px-1">L·ªùi nh·∫Øc (Prompt)</label>
                
                <!-- Badge ghi nh·ªõ ng·ªØ c·∫£nh -->
                <div id="repoContextBadge" class="hidden bg-green-50 border border-green-200 p-3 rounded-xl flex items-start gap-3 shadow-sm">
                    <span class="material-symbols-rounded text-green-600 text-lg flex-shrink-0 mt-0.5">push_pin</span>
                    <div class="flex-1">
                        <p class="text-xs text-green-800 font-medium">ƒê√£ ghi nh·ªõ d·ª± √°n.</p>
                        <p class="text-[11px] text-green-600">S·∫µn s√†ng d·∫°y t·ª´ng b∆∞·ªõc.</p>
                    </div>
                    <button onclick="clearRepoIndex()" class="text-green-500 hover:text-green-700 transition-colors" title="X√≥a ghi nh·ªõ">
                        <span class="material-symbols-rounded text-lg">close</span>
                    </button>
                </div>

                <div class="relative">
                    <textarea id="promptInput" class="w-full h-32 p-3 rounded-xl border border-gray-300 bg-white text-sm text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none shadow-sm transition-all" placeholder="Nh·∫≠p v√†o c√°c m·∫´u b√™n tr√™n ho·∫∑c t·ª± d√°n link GitHub / nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
                </div>
                
                <button id="sendPromptButton" class="w-full bg-primary hover:bg-primary-hover disabled:bg-blue-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded text-xl">sparkles</span>
                    <span id="buttonText">G·ª≠i t·ªõi Gemini</span>
                    <div id="buttonSpinner" class="spinner hidden"></div>
                </button>
                
                <!-- Status Message -->
                <p id="statusMessage" class="text-xs text-center font-medium mt-1 px-2 transition-colors"></p>
            </section>

            <!-- L·ªãch s·ª≠ (C√°c d·ª± √°n ƒë√£ h·ªçc) -->
            <section>
                <div class="flex items-center justify-between mb-3 px-1 mt-2 border-t border-gray-100 pt-4">
                    <h2 class="text-sm font-medium text-gray-600">C√°c d·ª± √°n ƒë√£ h·ªçc</h2>
                </div>
                <div id="historyList" class="space-y-2">
                    <!-- S·∫Ω ƒë∆∞·ª£c ƒë·ªï data t·ª´ JS -->
                    <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <span class="material-symbols-rounded text-gray-300 text-3xl mb-2">folder_off</span>
                        <p class="text-xs text-gray-400">Ch∆∞a c√≥ d·ª± √°n n√†o ƒë∆∞·ª£c h·ªçc.</p>
                    </div>
                </div>
            </section>
        </div>
        
        <div class="p-4 border-t border-gray-200 text-xs text-center text-gray-400">
            ¬© 2026 AI Tutor Platform
        </div>
    </aside>

    <!-- C·ªòT PH·∫¢I (MAIN CONTENT) -->
    <main class="flex-1 flex flex-col relative bg-white">
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-4 md:px-6 border-b border-gray-100 bg-white z-10 flex-shrink-0">
            <div class="flex items-center gap-4">
                <button id="menuToggle" class="md:hidden p-2 -ml-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <span class="text-sm font-medium text-gray-600">Phi√™n l√†m vi·ªác</span>
            </div>
            
            <!-- V√πng hi·ªÉn th·ªã Auth -->
            <div class="flex items-center gap-2">
                <div id="userInfoDisplay" class="hidden flex items-center gap-3">
                    <span id="userEmail" class="text-sm text-gray-600 hidden sm:block max-w-[150px] truncate"></span>
                    <button onclick="logoutUser()" class="text-xs font-medium text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-full transition-colors border border-red-100">ƒêƒÉng xu·∫•t</button>
                </div>
                <div id="userAvatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 text-white flex items-center justify-center text-xs font-bold shadow-sm cursor-pointer hidden">
                    U
                </div>
            </div>
        </header>

        <!-- Body -->
        <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            <div class="max-w-4xl mx-auto w-full flex flex-col h-full">
                
                <!-- Tr·∫°ng th√°i tr·ªëng (Empty State) -->
                <div id="emptyStateContainer" class="flex-1 flex flex-col items-center justify-center text-center animate-fade-in py-10">
                    <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-8 shadow-sm">
                        <span class="material-symbols-rounded text-primary text-5xl">smart_toy</span>
                    </div>
                    <h2 class="font-display text-3xl md:text-4xl text-gray-800 mb-4 font-normal">
                        Xin ch√†o!
                    </h2>
                    <p class="max-w-xl text-lg text-gray-500 leading-relaxed font-light">
                        H√£y d√°n m·ªôt ƒë∆∞·ªùng d·∫´n GitHub ho·∫∑c nh·∫≠p l·ªùi nh·∫Øc ·ªü c·ªôt b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu bu·ªïi h·ªçc. T√¥i s·∫µn s√†ng h·ªó tr·ª£ b·∫°n l·∫≠p tr√¨nh.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-12 max-w-2xl w-full">
                        <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md transition-all text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="material-symbols-rounded text-orange-500 bg-orange-100 p-1.5 rounded-lg">code</span>
                                <h3 class="font-medium text-gray-700">Ph√¢n t√≠ch m√£ ngu·ªìn</h3>
                            </div>
                            <p class="text-sm text-gray-500">Hi·ªÉu r√µ c·∫•u tr√∫c v√† logic c·ªßa repo GitHub.</p>
                        </div>
                        <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md transition-all text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="material-symbols-rounded text-purple-500 bg-purple-100 p-1.5 rounded-lg">bug_report</span>
                                <h3 class="font-medium text-gray-700">G·ª° l·ªói th√¥ng minh</h3>
                            </div>
                            <p class="text-sm text-gray-500">T√¨m v√† s·ª≠a l·ªói nhanh ch√≥ng v·ªõi gi·∫£i th√≠ch chi ti·∫øt.</p>
                        </div>
                    </div>
                </div>

                <!-- L·ªãch s·ª≠ Chat -->
                <div id="chatHistoryContainer" class="flex-1"></div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="hidden flex items-center gap-3 text-gray-500 py-6 mb-4">
                    <div class="large-spinner spinner"></div>
                    <span class="text-sm font-medium animate-pulse">ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...</span>
                </div>

                <!-- Thao t√°c nhanh -->
                <div id="quickActions" class="hidden mt-6 pt-6 border-t border-gray-100 flex flex-wrap gap-3 pb-8">
                    <button id="btnNextStep" class="flex items-center gap-2 px-5 py-2.5 bg-blue-50 text-primary hover:bg-blue-100 hover:text-blue-700 rounded-full font-medium text-sm transition-all border border-blue-100">
                        <span>Ti·∫øp t·ª•c b∆∞·ªõc ti·∫øp theo</span>
                        <span class="material-symbols-rounded text-lg">arrow_forward</span>
                    </button>
                    <button id="btnGotBug" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 rounded-full font-medium text-sm transition-all shadow-sm">
                        <span>T√¥i g·∫∑p l·ªói ·ªü b∆∞·ªõc n√†y</span>
                        <span class="material-symbols-rounded text-lg text-orange-500">bug_report</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- N√∫t Cu·ªôn l√™n ƒë·∫ßu trang (N·∫±m trong th·∫ª Main ƒë·ªÉ fixed theo viewport) -->
        <button id="scrollToTopBtn" class="fixed bottom-6 right-6 w-12 h-12 bg-primary text-white rounded-full shadow-xl flex items-center justify-center z-50 hover:bg-primary-hover hover:-translate-y-1 transition-all opacity-0 translate-y-4 pointer-events-none" title="Cu·ªôn l√™n ƒë·∫ßu trang">
            <span class="material-symbols-rounded">arrow_upward</span>
        </button>
    </main>

    <!-- MODALS -->
    <!-- Modal X√°c nh·∫≠n (Confirm) -->
    <div id="confirmModal" class="custom-modal-overlay fixed inset-0 bg-gray-900/40 z-[999] flex items-center justify-center backdrop-blur-sm">
        <div class="custom-modal bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <h3 class="font-display text-lg font-medium text-gray-800 mb-2">X√°c nh·∫≠n</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc ch·∫Øn?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('confirmModal')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">H·ªßy</button>
                <button id="confirmYesBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-xl transition-colors shadow-sm">ƒê·ªìng √Ω x√≥a</button>
            </div>
        </div>
    </div>

    <!-- Modal Nh·∫≠p li·ªáu (Prompt) -->
    <div id="promptModal" class="custom-modal-overlay fixed inset-0 bg-gray-900/40 z-[999] flex items-center justify-center backdrop-blur-sm">
        <div class="custom-modal bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <h3 id="promptTitle" class="font-display text-lg font-medium text-gray-800 mb-4">Nh·∫≠p th√¥ng tin</h3>
            <input type="text" id="promptInputVal" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm text-gray-800 mb-6" autocomplete="off">
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('promptModal')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">H·ªßy</button>
                <button id="promptYesBtn" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors shadow-sm">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Modal Auth (ƒêƒÉng nh·∫≠p) -->
    <div id="authModal" class="custom-modal-overlay show fixed inset-0 bg-gray-900/60 z-[1000] flex items-center justify-center backdrop-blur-md">
        <div class="custom-modal bg-white rounded-3xl p-8 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary">
                    <span class="material-symbols-rounded text-3xl">cloud_sync</span>
                </div>
                <h3 class="font-display text-2xl font-medium text-gray-800 mb-2">ƒê·ªìng b·ªô ƒê√°m m√¢y</h3>
                <p class="text-gray-500 text-sm">ƒêƒÉng nh·∫≠p ƒë·ªÉ t·ª± ƒë·ªông l∆∞u v√† ƒë·ªìng b·ªô l·ªãch s·ª≠ h·ªçc t·∫≠p c·ªßa b·∫°n qua Firestore.</p>
            </div>
            
            <div id="authError" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-xl mb-4 border border-red-100 font-medium text-center"></div>
            
            <div class="space-y-4 mb-8">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1 ml-1">Email</label>
                    <input type="email" id="authEmail" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm" placeholder="user@email.com">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1 ml-1">M·∫≠t kh·∫©u</label>
                    <input type="password" id="authPassword" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm" placeholder="√çt nh·∫•t 6 k√Ω t·ª±">
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="registerUser()" class="flex-1 py-3 text-sm font-medium text-primary bg-blue-50 hover:bg-blue-100 rounded-xl transition-colors border border-blue-100">T·∫°o t√†i kho·∫£n</button>
                <button onclick="loginUser()" class="flex-1 py-3 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors shadow-md hover:shadow-lg">ƒêƒÉng nh·∫≠p</button>
            </div>
        </div>
    </div>

    <!-- LOGIC JS (Gi·ªØ nguy√™n 100% Core Logic c≈©) -->
    <script type="module">
        // Polyfill cho AbortSignal.any
        if (typeof AbortSignal !== 'undefined' && !AbortSignal.any) {
            AbortSignal.any = function(signals) {
                const controller = new AbortController();
                for (const signal of signals) {
                    if (signal.aborted) {
                        controller.abort(signal.reason);
                        return controller.signal;
                    }
                    signal.addEventListener('abort', () => controller.abort(signal.reason), { once: true });
                }
                return controller.signal;
            };
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-ai.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAtoX3PysX692bNg6nA55Qriv5P-7phmFQ",
          authDomain: "aiminh-d96d4.firebaseapp.com",
          projectId: "aiminh-d96d4",
          storageBucket: "aiminh-d96d4.firebasestorage.app",
          messagingSenderId: "159603803322",
          appId: "1:159603803322:web:3693589412fca5c3456e83"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const statusMessage = document.getElementById('statusMessage');

        // Bi·∫øn h·ªá th·ªëng
        let currentRepoId = null; 
        let sessionHistory = []; 
        let currentRepoIndex = ""; 
        let activeTemplateType = "custom"; 

        const emptyStateContainer = document.getElementById('emptyStateContainer');
        const chatHistoryContainer = document.getElementById('chatHistoryContainer');
        const historyList = document.getElementById('historyList');
        const quickActions = document.getElementById('quickActions');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // --- SCROLL TO TOP LOGIC ---
        const mainContentElement = document.getElementById('main-content');
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');

        mainContentElement.addEventListener('scroll', () => {
            if (mainContentElement.scrollTop > 300) {
                scrollToTopBtn.classList.add('show-scroll-btn');
            } else {
                scrollToTopBtn.classList.remove('show-scroll-btn');
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            mainContentElement.scrollTo({ top: 0, behavior: 'smooth' });
        });

        window.clearRepoIndex = function() {
            currentRepoId = null;
            currentRepoIndex = "";
            sessionHistory = [];
            document.getElementById('repoContextBadge').classList.add('hidden');
            quickActions.classList.add('hidden');
            chatHistoryContainer.innerHTML = '';
            emptyStateContainer.classList.remove('hidden'); // Hi·ªán l·∫°i m√†n h√¨nh ch√†o
            updateStatus('text-blue-600', "ƒê√£ t·∫°o phi√™n h·ªçc m·ªõi.");
        };

        // --- LOGIC AUTH ---
        const authModal = document.getElementById('authModal');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authError = document.getElementById('authError');
        const userInfoDisplay = document.getElementById('userInfoDisplay');
        const userEmailSpan = document.getElementById('userEmail');
        const userAvatar = document.getElementById('userAvatar');

        function showAuthError(msg) {
            authError.textContent = msg;
            authError.classList.remove('hidden');
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authModal.classList.remove('show');
                userInfoDisplay.classList.remove('hidden');
                userAvatar.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                userAvatar.textContent = user.email.charAt(0).toUpperCase();
                updateStatus('text-blue-600', "ƒê√£ k·∫øt n·ªëi ƒë√°m m√¢y. ƒêang t·∫£i d·ªØ li·ªáu...");
                loadHistory(); 
            } else {
                authModal.classList.add('show');
                userInfoDisplay.classList.add('hidden');
                userAvatar.classList.add('hidden');
                historyList.innerHTML = `
                    <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <span class="material-symbols-rounded text-gray-300 text-3xl mb-2">lock</span>
                        <p class="text-xs text-gray-400">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem.</p>
                    </div>`;
                clearRepoIndex(); 
            }
        });

        window.loginUser = async function() {
            try {
                showAuthError("ƒêang ƒëƒÉng nh·∫≠p...");
                authError.classList.replace('bg-red-50', 'bg-blue-50');
                authError.classList.replace('text-red-600', 'text-blue-600');
                await signInWithEmailAndPassword(auth, authEmail.value, authPassword.value);
            } catch (error) {
                authError.classList.replace('bg-blue-50', 'bg-red-50');
                authError.classList.replace('text-blue-600', 'text-red-600');
                showAuthError("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
            }
        };

        window.registerUser = async function() {
            try {
                showAuthError("ƒêang t·∫°o t√†i kho·∫£n...");
                authError.classList.replace('bg-red-50', 'bg-blue-50');
                authError.classList.replace('text-red-600', 'text-blue-600');
                await createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value);
            } catch (error) {
                authError.classList.replace('bg-blue-50', 'bg-red-50');
                authError.classList.replace('text-blue-600', 'text-red-600');
                showAuthError("L·ªói ƒëƒÉng k√Ω: " + error.message);
            }
        };

        window.logoutUser = async function() {
            await signOut(auth);
        };

        // --- LOGIC CUSTOM MODAL ---
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showCustomConfirm(message, onConfirm) {
            document.getElementById('confirmMessage').innerText = message;
            const overlay = document.getElementById('confirmModal');
            const yesBtn = document.getElementById('confirmYesBtn');
            overlay.classList.add('show');
            yesBtn.onclick = function() { closeModal('confirmModal'); onConfirm(); };
        }

        function showCustomPrompt(title, defaultVal, onConfirm) {
            document.getElementById('promptTitle').innerText = title;
            const inputField = document.getElementById('promptInputVal');
            const overlay = document.getElementById('promptModal');
            const yesBtn = document.getElementById('promptYesBtn');
            inputField.value = defaultVal;
            overlay.classList.add('show');
            inputField.focus();
            yesBtn.onclick = function() { closeModal('promptModal'); onConfirm(inputField.value); };
            inputField.onkeydown = function(e) { if (e.key === 'Enter') yesBtn.click(); }
        }

        // --- LOGIC L∆ØU TR·ªÆ FIRESTORE ---
        let currentUserRepos = [];

        async function loadHistory() {
            if (!auth.currentUser) return;
            const q = query(collection(db, `users/${auth.currentUser.uid}/repos`), orderBy("updatedAt", "desc"));
            try {
                const querySnapshot = await getDocs(q);
                currentUserRepos = [];
                historyList.innerHTML = "";
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = `
                        <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                            <span class="material-symbols-rounded text-gray-300 text-3xl mb-2">folder_off</span>
                            <p class="text-xs text-gray-400">Ch∆∞a c√≥ d·ª± √°n n√†o.</p>
                        </div>`;
                    return;
                }
                
                querySnapshot.forEach(docSnap => {
                    const repo = { id: docSnap.id, ...docSnap.data() };
                    currentUserRepos.push(repo);
                    
                    const dateStr = new Date(repo.updatedAt).toLocaleString('vi-VN', {hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
                    const item = document.createElement('div');
                    item.className = 'group flex items-center justify-between p-3 rounded-xl border border-transparent bg-gray-50 hover:bg-blue-50 hover:border-blue-100 cursor-pointer transition-all mb-2';
                    item.innerHTML = `
                        <div style="overflow: hidden; flex-grow: 1;" onclick="viewRepo('${repo.id}')">
                            <div class="text-sm font-medium text-gray-700 truncate">${repo.title}</div>
                            <div class="text-[11px] text-gray-500 mt-0.5">${repo.history.length} m·ª•c ‚Ä¢ ${dateStr}</div>
                        </div>
                        <button class="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" onclick="deleteRepo('${repo.id}', event)" title="X√≥a">
                            <span class="material-symbols-rounded text-[18px]">delete</span>
                        </button>
                    `;
                    historyList.appendChild(item);
                });
            } catch (error) {
                console.error("L·ªói t·∫£i Firestore:", error);
                updateStatus('text-red-600', "L·ªói t·∫£i d·ªØ li·ªáu. Ki·ªÉm tra Rules.");
            }
        }

        window.viewRepo = function(id) {
            const repo = currentUserRepos.find(r => r.id === id);
            if(repo) {
                currentRepoId = repo.id;
                currentRepoIndex = repo.repoIndex || "";
                sessionHistory = repo.history || [];
                
                renderChatHistory(); 
                
                if (currentRepoIndex !== "") {
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }
                quickActions.classList.remove('hidden');
                updateStatus('text-blue-600', `ƒêang h·ªçc d·ª± √°n: ${repo.title}`);
                
                if(window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('open')) {
                    toggleSidebar();
                }
            }
        };

        window.deleteRepo = function(id, event) {
            event.stopPropagation();
            showCustomConfirm("X√≥a to√†n b·ªô ti·∫øn tr√¨nh h·ªçc c·ªßa d·ª± √°n n√†y tr√™n ƒë√°m m√¢y?", async () => {
                try {
                    await deleteDoc(doc(db, `users/${auth.currentUser.uid}/repos`, id));
                    if (currentRepoId === id) clearRepoIndex(); 
                    loadHistory();
                    updateStatus('text-green-600', "ƒê√£ x√≥a d·ª± √°n tr√™n ƒë√°m m√¢y.");
                } catch (error) {
                    alert("L·ªói khi x√≥a: " + error.message);
                }
            });
        };

        async function autoSaveRepo() {
            if (!auth.currentUser || sessionHistory.length === 0) return;
            const reposRef = collection(db, `users/${auth.currentUser.uid}/repos`);

            if (currentRepoId === null) {
                let defaultTitle = "D·ª± √°n: " + sessionHistory[0].prompt.split('\n')[0].substring(0, 25) + "...";
                showCustomPrompt("ƒê·∫∑t t√™n d·ª± √°n ƒë·ªÉ l∆∞u l√™n ƒë√°m m√¢y:", defaultTitle, async (title) => {
                    if (title.trim() === "") title = defaultTitle;
                    const newRepoRef = doc(reposRef);
                    currentRepoId = newRepoRef.id; 
                    await setDoc(newRepoRef, {
                        title: title, repoIndex: currentRepoIndex, history: sessionHistory, updatedAt: new Date().getTime()
                    });
                    loadHistory();
                });
            } else {
                const repoRef = doc(db, `users/${auth.currentUser.uid}/repos`, currentRepoId);
                await setDoc(repoRef, {
                    repoIndex: currentRepoIndex, history: sessionHistory, updatedAt: new Date().getTime()
                }, { merge: true }); 
                loadHistory();
            }
        }

        // --- RENDER GIAO DI·ªÜN CHAT V√Ä AUTO SCROLL ---
        function renderChatHistory(isNewMessage = false) {
            emptyStateContainer.classList.add('hidden'); // ·∫®n m√†n h√¨nh ch√†o
            chatHistoryContainer.innerHTML = "";
            
            sessionHistory.forEach(item => {
                const block = document.createElement('div');
                block.className = 'mb-8 pb-6 border-b border-gray-100 last:border-0 chat-block';
                block.innerHTML = `
                    <div class="bg-blue-50/50 p-4 rounded-2xl rounded-tr-sm border border-blue-100/50 text-gray-800 font-medium mb-5 text-[15px] whitespace-pre-wrap flex gap-3 shadow-sm">
                        <span class="material-symbols-rounded text-primary flex-shrink-0 mt-0.5">person</span>
                        <div class="leading-relaxed">${item.prompt}</div>
                    </div>
                    <div class="markdown-body !text-[15px] leading-relaxed text-gray-800">
                        ${marked.parse(item.response)}
                    </div>
                `;
                chatHistoryContainer.appendChild(block);
            });

            // Logic t·ª± ƒë·ªông cu·ªôn
            if (isNewMessage) {
                // Cu·ªôn ch√≠nh x√°c l√™n m√©p ƒë·∫ßu c·ªßa c√¢u tr·∫£ l·ªùi v·ª´a xu·∫•t hi·ªán
                const lastBlock = chatHistoryContainer.lastElementChild;
                if (lastBlock) {
                    setTimeout(() => {
                        lastBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 50); // Ch·ªù DOM render xong
                }
            } else {
                // Khi load b√†i c≈© t·ª´ sidebar th√¨ cu·ªôn th·∫≥ng xu·ªëng ƒë√°y m√†n h√¨nh
                mainContentElement.scrollTop = mainContentElement.scrollHeight;
            }
        }

        // --- QUICK ACTIONS ---
        document.getElementById('btnNextStep').addEventListener('click', () => {
            promptInput.value = "T√¥i ƒë√£ ho√†n th√†nh b∆∞·ªõc v·ª´a r·ªìi. H√£y ti·∫øp t·ª•c h∆∞·ªõng d·∫´n t√¥i b∆∞·ªõc ti·∫øp theo.";
            sendPromptButton.click();
        });

        document.getElementById('btnGotBug').addEventListener('click', () => {
            promptInput.value = "T√¥i g·∫∑p l·ªói ·ªü b∆∞·ªõc n√†y. L√Ω do c√≥ th·ªÉ l√† g√¨ v√† l√†m sao ƒë·ªÉ ki·ªÉm tra/kh·∫Øc ph·ª•c? ƒê√¢y l√† m√£ l·ªói t√¥i th·∫•y:\n[D√ÅN M√É L·ªñI V√ÄO ƒê√ÇY]";
            promptInput.focus();
            if(window.innerWidth <= 768 && !document.getElementById('sidebar').classList.contains('open')) {
                toggleSidebar();
            }
        });

        // --- CH·ª®C NƒÇNG COPY CODE ---
        // L·∫Øng nghe s·ª± ki·ªán click tr√™n to√†n document ƒë·ªÉ b·∫Øt n√∫t "Sao ch√©p"
        document.addEventListener('click', function(e) {
            const copyBtn = e.target.closest('.copy-btn');
            if (!copyBtn) return;

            const codeToCopy = decodeURIComponent(copyBtn.getAttribute('data-code'));
            
            // X·ª≠ l√Ω logic copy b·∫±ng textarea (t∆∞∆°ng th√≠ch c·∫£ iFrame)
            const textArea = document.createElement("textarea");
            textArea.value = codeToCopy;
            // Tr√°nh scroll m√†n h√¨nh khi ch√®n textarea
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const icon = copyBtn.querySelector('.material-symbols-rounded');
                    const text = copyBtn.querySelector('.copy-text');
                    
                    const originalIcon = icon.innerText;
                    const originalText = text.innerText;
                    
                    // Hi·ªÉn th·ªã tr·∫°ng th√°i th√†nh c√¥ng
                    icon.innerText = 'check';
                    icon.classList.add('text-green-500');
                    text.innerText = 'ƒê√£ ch√©p!';
                    text.classList.add('text-green-500');
                    
                    // Reset l·∫°i sau 2 gi√¢y
                    setTimeout(() => {
                        icon.innerText = originalIcon;
                        icon.classList.remove('text-green-500');
                        text.innerText = originalText;
                        text.classList.remove('text-green-500');
                    }, 2000);
                }
            } catch (err) {
                console.error('L·ªói khi copy', err);
            }
            document.body.removeChild(textArea);
        });

        // --- SIDEBAR MOBILE ---
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            if(sidebar.classList.contains('open')) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('opacity-100'), 10);
            } else {
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }
        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        // --- HELPERS & AI ---
        function updateStatus(colorClass, message) {
            statusMessage.className = `text-xs text-center font-medium mt-1 px-2 transition-colors ${colorClass}`;
            statusMessage.innerHTML = message; 
        }

        updateStatus('text-blue-600', "Firebase App kh·ªüi t·∫°o.<br>ƒêang ch·ªù m√¥ h√¨nh AI...");

        // Ghi ƒë√® b·ªô c·∫•u h√¨nh Render c·ªßa Marked.js ƒë·ªÉ t·∫°o ra Giao di·ªán Code Block m·ªõi c·ª±c ƒë·∫πp
        const renderer = new marked.Renderer();
        renderer.code = function(codeOrToken, language) {
            let code = codeOrToken;
            let lang = language;
            
            // X·ª≠ l√Ω t∆∞∆°ng th√≠ch cho c√°c phi√™n b·∫£n Marked.js kh√°c nhau
            if (typeof codeOrToken === 'object') {
                code = codeOrToken.text;
                lang = codeOrToken.lang;
            }
            
            const validLang = (lang && hljs.getLanguage(lang)) ? lang : 'plaintext';
            const highlighted = validLang === 'plaintext' ? hljs.highlightAuto(code).value : hljs.highlight(code, { language: validLang }).value;
            const encodedCode = encodeURIComponent(code); // M√£ h√≥a code an to√†n ƒë·ªÉ g√°n v√†o n√∫t

            return `
            <div class="code-block-wrapper rounded-xl overflow-hidden bg-[#0d1117] border border-gray-700 my-5 shadow-md">
                <div class="flex items-center justify-between px-4 py-2.5 bg-[#161b22] border-b border-gray-700">
                    <span class="text-[11px] font-medium text-gray-400 uppercase tracking-wider">${validLang}</span>
                    <button class="copy-btn flex items-center gap-1.5 text-[12px] text-gray-400 hover:text-white transition-colors focus:outline-none" data-code="${encodedCode}">
                        <span class="material-symbols-rounded text-[16px]">content_copy</span> 
                        <span class="copy-text">Sao ch√©p</span>
                    </button>
                </div>
                <div class="p-4 overflow-x-auto text-[14px]">
                    <pre class="!m-0 !bg-transparent !p-0"><code class="hljs language-${validLang} !text-[#e6edf3] !bg-transparent">${highlighted}</code></pre>
                </div>
            </div>`;
        };

        // K√≠ch ho·∫°t custom renderer
        marked.use({ renderer });

        const systemPrompt = `You are an AI Technical Tutor.

Your task is to turn any GitHub repository into a complete, beginner-friendly tutorial.

Assume the user is a beginner developer.
Never skip steps.
Never assume prior knowledge.

For every repository, always follow this structure:
1. Explain what problem this repository solves.
2. Explain the big picture architecture.
3. Show the file structure and which file to start with.
4. Explain the execution flow from input to output.
5. Give step-by-step terminal commands to run locally.
6. Explain each command and what it does.
7. Explain how to modify or extend the project.
8. Explain how to deploy (if applicable).

Rules:
- Use simple language.
- Explain before showing code.
- When showing code, explain what each part does.
- Never say "just run this".
- Teach like a real instructor, not like a chatbot.`;

        let model;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash", systemInstruction: systemPrompt });
            updateStatus('text-green-600', "AI Tutor ƒë√£ s·∫µn s√†ng.");
        } catch (e) {
            updateStatus('text-red-600', `L·ªói AI: ${e.message}`);
        }

        const templates = {
            explain: "H√£y ƒë√≥ng vai m·ªôt chuy√™n gia l·∫≠p tr√¨nh. ƒê·ªçc repository d∆∞·ªõi ƒë√¢y v√† t·∫°o ra m·ªôt b·∫£n t√≥m t·∫Øt ki·∫øn tr√∫c d·ª± √°n, lu·ªìng ho·∫°t ƒë·ªông ch√≠nh v√† c√°c file quan tr·ªçng. Gi·∫£i th√≠ch cho t√¥i hi·ªÉu nh∆∞ m·ªôt ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu.\n\n[D√ÅN LINK GITHUB HO·∫∂C M√É NGU·ªíN V√ÄO ƒê√ÇY]",
            tutor: "B√¢y gi·ªù h√£y d·∫°y t√¥i th·ª±c h√†nh d·ª± √°n tr√™n t·ª´ng b∆∞·ªõc m·ªôt.\nSau m·ªói b∆∞·ªõc, h√£y ƒë·ª£i t√¥i x√°c nh·∫≠n tr∆∞·ªõc khi ti·∫øp t·ª•c.\nN·∫øu t√¥i g·∫∑p l·ªói, h√£y gi√∫p t√¥i s·ª≠a (debug).",
            debug: "T√¥i nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o l·ªói n√†y trong qu√° tr√¨nh l√†m. H√£y gi·∫£i th√≠ch b·∫±ng ng√¥n ng·ªØ ƒë∆°n gi·∫£n t·∫°i sao l·∫°i b·ªã l·ªói v√† c√°ch kh·∫Øc ph·ª•c.\n[D√ÅN LOG L·ªñI V√ÄO ƒê√ÇY]",
            customize: "T√¥i mu·ªën t√πy ch·ªânh d·ª± √°n n√†y cho m·ª•c ƒë√≠ch c√° nh√¢n c·ªßa m√¨nh:\n[ƒêI·ªÄN M·ª§C TI√äU C·ª¶A B·∫†N V√ÄO ƒê√ÇY]\n\nH√£y gi·∫£i th√≠ch nh·ªØng g√¨ t√¥i c·∫ßn thay ƒë·ªïi trong m√£ ngu·ªìn.",
            deploy: "H√£y h∆∞·ªõng d·∫´n t√¥i c√°ch tri·ªÉn khai (deploy) d·ª± √°n n√†y l√™n m·∫°ng.\nC·ª© gi·∫£ ƒë·ªãnh r·∫±ng t√¥i ch∆∞a t·ª´ng deploy b·∫•t c·ª© th·ª© g√¨ tr∆∞·ªõc ƒë√¢y.\nH√£y gi·∫£i th√≠ch c·∫∑n k·∫Ω t·ª´ng b∆∞·ªõc."
        };

        window.setTemplate = function(type) {
            activeTemplateType = type; 
            promptInput.value = templates[type];
            promptInput.focus();
            if(window.innerWidth <= 768 && sidebar.classList.contains('open')) { /* toggleSidebar(); */ }
        };

        async function callGeminiAPI() {
            if (!model) return updateStatus('text-red-600', "M√¥ h√¨nh AI l·ªói.");
            const promptText = promptInput.value.trim();
            if (!promptText) return updateStatus('text-red-600', "Vui l√≤ng nh·∫≠p l·ªùi nh·∫Øc!");

            updateStatus('text-blue-600', "ƒêang g·ª≠i y√™u c·∫ßu...");
            
            quickActions.classList.add('hidden');
            emptyStateContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            buttonText.textContent = 'ƒêang x·ª≠ l√Ω...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            if(window.innerWidth <= 768 && sidebar.classList.contains('open')) toggleSidebar();

            let finalPrompt = promptText;
            if (currentRepoIndex !== "" && activeTemplateType !== 'explain') {
                finalPrompt = `[NG·ªÆ C·∫¢NH D·ª∞ √ÅN T·ª™ PAGE INDEX ƒê√É L∆ØU]:\n${currentRepoIndex}\n\n`;
                if (sessionHistory.length > 0) {
                    finalPrompt += `[B∆Ø·ªöC B·∫†N V·ª™A H∆Ø·ªöNG D·∫™N ·ªû TR∆Ø·ªöC ƒê√ì]:\n${sessionHistory[sessionHistory.length - 1].response}\n\n`;
                }
                finalPrompt += `---\n[Y√äU C·∫¶U M·ªöI C·ª¶A T√îI]:\n${promptText}`;
            }

            try {
                const result = await model.generateContent(finalPrompt);
                const text = result.response.text();

                if (activeTemplateType === 'explain') {
                    currentRepoIndex = text;
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }

                sessionHistory.push({ prompt: promptText, response: text });
                promptInput.value = "";

                loadingIndicator.classList.add('hidden');
                
                // G·ªçi render v·ªõi c·ªù true ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông scroll ƒë·∫øn ƒë·∫ßu tin nh·∫Øn m·ªõi nh·∫•t
                renderChatHistory(true);
                
                autoSaveRepo();
                
                updateStatus('text-green-600', activeTemplateType === 'explain' ? "üìå ƒê√£ t·ª± ƒë·ªông l∆∞u d·ª± √°n!" : "ƒê√£ l∆∞u ti·∫øn tr√¨nh.");
                activeTemplateType = "custom";
                quickActions.classList.remove('hidden');

            } catch (error) {
                loadingIndicator.classList.add('hidden');
                updateStatus('text-red-600', `L·ªói: ${error.message}.`);
                alert("L·ªói g·ªçi API: " + error.message);
            } finally {
                buttonText.textContent = 'G·ª≠i t·ªõi Gemini';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
            }
        }

        if (sendPromptButton) sendPromptButton.addEventListener("click", callGeminiAPI);
    </script>
</body>
</html>
