<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Gia Sư Lập Trình AI - Material Design 3</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Roboto"', 'sans-serif'],
                        display: ['"Google Sans"', 'sans-serif'],
                    },
                    colors: {
                        primary: "#1a73e8", 
                        "primary-hover": "#1557b0",
                        "background-light": "#f8f9fa",
                        "surface-light": "#ffffff",
                    }
                },
            },
        };
    </script>

    <!-- Thư viện Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ĐỔI THEME DARK SANG THEME LIGHT DỊU MẮT HƠN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">

    <!-- CSS bổ sung cho Scrollbar, Animation và Override Markdown -->
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #bdc1c6; }
        
        .markdown-body { background: transparent !important; font-family: inherit !important; }
        
        /* Tinh chỉnh lại hiển thị của Inline Code và Code Block tránh lỗi nền đen chữ đen */
        .markdown-body p code, .markdown-body li code, .markdown-body a code {
            background-color: #f1f5f9 !important;
            color: #e11d48 !important; /* Màu đỏ đô nổi bật trên nền sáng */
            padding: 0.2rem 0.4rem !important;
            border-radius: 0.375rem !important;
            font-size: 0.875em !important;
        }
        .markdown-body pre { background-color: transparent !important; padding: 0 !important; }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%;
            width: 18px; height: 18px; animation: spin 1s linear infinite;
        }
        .large-spinner {
            width: 32px; height: 32px; border-width: 3px; border-color: rgba(26, 115, 232, 0.2);
            border-left-color: #1a73e8; margin: 0;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Custom Modal Transition */
        .custom-modal-overlay {
            opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s;
        }
        .custom-modal-overlay.show { opacity: 1; visibility: visible; }
        .custom-modal { transform: translateY(-20px); transition: transform 0.2s; }
        .custom-modal-overlay.show .custom-modal { transform: translateY(0); }
        
        /* Sidebar transition cho Mobile */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (max-width: 768px) {
            #sidebar { position: fixed; transform: translateX(-100%); z-index: 50; }
            #sidebar.open { transform: translateX(0); }
        }

        /* Nút Cuộn Lên Đầu Trang */
        .show-scroll-btn {
            opacity: 1 !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
        }

        /* Transition cho Modal Cửa sổ Gia sư & Explorer */
        .slide-up-modal { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* CSS cho Tree View (GitHub Explorer) */
        .tree-item { display: flex; items-center; padding: 6px 10px; cursor: pointer; border-radius: 6px; transition: background 0.2s; font-size: 14px; color: #374151; }
        .tree-item:hover { background-color: #f3f4f6; }
        .tree-item.selected { background-color: #e0e7ff; color: #1a73e8; font-weight: 500; }
        .tree-icon { margin-right: 8px; font-size: 18px; color: #6b7280; }
        .tree-item:hover .tree-icon { color: #1a73e8; }
        .tree-children { padding-left: 18px; border-left: 1px dashed #e5e7eb; margin-left: 18px; display: none; }
        .tree-children.open { display: block; }
    </style>
</head>
<body class="bg-background-light text-gray-800 font-sans h-screen flex overflow-hidden selection:bg-primary selection:text-white relative">

    <!-- Sidebar Overlay (Mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-gray-900/50 z-40 hidden opacity-0 transition-opacity"></div>

    <!-- CỘT TRÁI (SIDEBAR) -->
    <aside id="sidebar" class="w-80 md:w-96 flex flex-col border-r border-gray-200 bg-surface-light shadow-sm h-full flex-shrink-0 z-50">
        <div class="p-5 pb-2 border-b border-transparent">
            <h1 class="font-display text-2xl font-medium text-primary flex items-center gap-2">
                <span class="material-symbols-rounded text-3xl">school</span> Gia Sư Lập Trình AI
            </h1>
            <div class="flex items-center gap-2 mt-2 px-1">
                <span class="material-symbols-rounded text-sm text-green-600">bolt</span>
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Mô hình: gemini-2.5-flash</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 py-4 space-y-6">
            <!-- Khung Mẫu -->
            <section>
                <div class="flex items-center justify-between mb-3 px-1">
                    <h2 class="text-sm font-medium text-gray-600">Khung mẫu (Templates)</h2>
                    <span class="material-symbols-rounded text-gray-400 text-lg cursor-pointer hover:text-primary">info</span>
                </div>
                <div class="space-y-2">
                    <button onclick="setTemplate('explain')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">menu_book</span>
                        <span class="text-sm font-medium text-gray-700">1. Giải thích Repo (Nhập môn)</span>
                    </button>
                    <button onclick="setTemplate('tutor')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md relative overflow-hidden">
                        <div class="absolute right-0 top-0 h-full w-1 bg-primary"></div>
                        <span class="material-symbols-rounded text-primary group-hover:text-primary-hover">model_training</span>
                        <span class="text-sm font-medium text-primary group-hover:text-primary-hover">2. Dạy từng bước (Cửa sổ riêng)</span>
                    </button>
                    <button onclick="setTemplate('debug')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">bug_report</span>
                        <span class="text-sm font-medium text-gray-700">3. Sửa lỗi (Debug Terminal)</span>
                    </button>
                    <button onclick="setTemplate('customize')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">tune</span>
                        <span class="text-sm font-medium text-gray-700">4. Tùy chỉnh Project</span>
                    </button>
                    <button onclick="setTemplate('deploy')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">rocket_launch</span>
                        <span class="text-sm font-medium text-gray-700">5. Hướng dẫn Triển khai</span>
                    </button>
                </div>
            </section>

            <!-- Lời nhắc -->
            <section class="flex flex-col gap-3">
                <label class="text-sm font-medium text-gray-600 px-1">Lời nhắc (Prompt)</label>
                
                <!-- Badge ghi nhớ ngữ cảnh -->
                <div id="repoContextBadge" class="hidden bg-green-50 border border-green-200 p-3 rounded-xl flex items-start gap-3 shadow-sm">
                    <span class="material-symbols-rounded text-green-600 text-lg flex-shrink-0 mt-0.5">push_pin</span>
                    <div class="flex-1">
                        <p class="text-xs text-green-800 font-medium">Đã ghi nhớ dự án.</p>
                        <p class="text-[11px] text-green-600" id="repoContextSubtext">Sẵn sàng dạy từng bước.</p>
                    </div>
                    <button onclick="clearRepoIndex()" class="text-green-500 hover:text-green-700 transition-colors" title="Xóa ghi nhớ">
                        <span class="material-symbols-rounded text-lg">close</span>
                    </button>
                </div>

                <div class="relative">
                    <textarea id="promptInput" class="w-full h-32 p-3 rounded-xl border border-gray-300 bg-white text-sm text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none shadow-sm transition-all" placeholder="Nhập vào các mẫu bên trên hoặc tự dán link GitHub / nhập câu hỏi của bạn vào đây..."></textarea>
                </div>
                
                <button id="sendPromptButton" class="w-full bg-primary hover:bg-primary-hover disabled:bg-blue-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded text-xl">sparkles</span>
                    <span id="buttonText">Gửi tới Gemini</span>
                    <div id="buttonSpinner" class="spinner hidden"></div>
                </button>
                
                <!-- Status Message -->
                <p id="statusMessage" class="text-xs text-center font-medium mt-1 px-2 transition-colors"></p>
            </section>

            <!-- Lịch sử (Các dự án đã học) -->
            <section>
                <div class="flex items-center justify-between mb-3 px-1 mt-2 border-t border-gray-100 pt-4">
                    <h2 class="text-sm font-medium text-gray-600">Các dự án đã học</h2>
                </div>
                <div id="historyList" class="space-y-2">
                    <!-- Sẽ được đổ data từ JS -->
                    <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <span class="material-symbols-rounded text-gray-300 text-3xl mb-2">folder_off</span>
                        <p class="text-xs text-gray-400">Chưa có dự án nào được học.</p>
                    </div>
                </div>
            </section>
        </div>
        
        <div class="p-4 border-t border-gray-200 text-xs text-center text-gray-400">
            © 2026 AI Tutor Platform
        </div>
    </aside>

    <!-- CỘT PHẢI (MAIN CONTENT) -->
    <main class="flex-1 flex flex-col relative bg-white">
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-4 md:px-6 border-b border-gray-100 bg-white z-10 flex-shrink-0">
            <div class="flex items-center gap-4">
                <button id="menuToggle" class="md:hidden p-2 -ml-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <span class="text-sm font-medium text-gray-600">Phiên làm việc chính</span>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Nút File Explorer (Ẩn mặc định) -->
                <button id="btnOpenExplorer" onclick="openExplorerModal()" class="hidden items-center gap-2 text-sm font-medium text-primary hover:bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-full transition-colors shadow-sm bg-white">
                    <span class="material-symbols-rounded text-[18px]">folder_open</span>
                    <span class="hidden sm:inline">Duyệt Mã Nguồn</span>
                </button>

                <!-- Vùng hiển thị Auth -->
                <div id="userInfoDisplay" class="hidden flex items-center gap-3 border-l border-gray-200 pl-3 ml-1">
                    <span id="userEmail" class="text-sm text-gray-600 hidden sm:block max-w-[150px] truncate"></span>
                    <button onclick="logoutUser()" class="text-xs font-medium text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-full transition-colors border border-red-100">Đăng xuất</button>
                </div>
                <div id="userAvatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 text-white flex items-center justify-center text-xs font-bold shadow-sm cursor-pointer hidden">
                    U
                </div>
            </div>
        </header>

        <!-- Body -->
        <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            <div class="max-w-4xl mx-auto w-full flex flex-col h-full">
                
                <!-- Trạng thái trống (Empty State) -->
                <div id="emptyStateContainer" class="flex-1 flex flex-col items-center justify-center text-center animate-fade-in py-10">
                    <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-8 shadow-sm">
                        <span class="material-symbols-rounded text-primary text-5xl">smart_toy</span>
                    </div>
                    <h2 class="font-display text-3xl md:text-4xl text-gray-800 mb-4 font-normal">
                        Xin chào!
                    </h2>
                    <p class="max-w-xl text-lg text-gray-500 leading-relaxed font-light">
                        Hãy dán một đường dẫn GitHub hoặc nhập lời nhắc ở cột bên trái để bắt đầu buổi học. Tôi sẵn sàng hỗ trợ bạn lập trình.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-12 max-w-2xl w-full">
                        <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md transition-all text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="material-symbols-rounded text-orange-500 bg-orange-100 p-1.5 rounded-lg">code</span>
                                <h3 class="font-medium text-gray-700">Phân tích mã nguồn</h3>
                            </div>
                            <p class="text-sm text-gray-500">Hiểu rõ cấu trúc và tự động duyệt cây thư mục của repo GitHub.</p>
                        </div>
                        <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md transition-all text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="material-symbols-rounded text-purple-500 bg-purple-100 p-1.5 rounded-lg">model_training</span>
                                <h3 class="font-medium text-gray-700">Dạy thực hành từng bước</h3>
                            </div>
                            <p class="text-sm text-gray-500">Mở một cửa sổ gia sư riêng biệt để hướng dẫn bạn code từng bước một.</p>
                        </div>
                    </div>
                </div>

                <!-- Lịch sử Chat -->
                <div id="chatHistoryContainer" class="flex-1"></div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="hidden flex items-center gap-3 text-gray-500 py-6 mb-4">
                    <div class="large-spinner spinner"></div>
                    <span class="text-sm font-medium animate-pulse">Đang phân tích dữ liệu...</span>
                </div>

                <!-- Thao tác nhanh -->
                <div id="quickActions" class="hidden mt-6 pt-6 border-t border-gray-100 flex flex-wrap gap-3 pb-8">
                    <!-- Nút tiếp tục học giáo án cũ -->
                    <button id="btnResumeTutor" class="hidden items-center gap-2 px-5 py-2.5 bg-blue-50 text-primary hover:bg-blue-100 hover:text-blue-700 rounded-full font-medium text-sm transition-all border border-blue-100 shadow-sm">
                        <span>Tiếp tục thực hành</span>
                        <span class="material-symbols-rounded text-lg">model_training</span>
                    </button>
                    <!-- Nút gỡ lỗi chung -->
                    <button id="btnGotBug" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 rounded-full font-medium text-sm transition-all shadow-sm">
                        <span>Hỏi thêm / Gỡ lỗi</span>
                        <span class="material-symbols-rounded text-lg text-orange-500">bug_report</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Nút Cuộn lên đầu trang -->
        <button id="scrollToTopBtn" class="fixed bottom-6 right-6 w-12 h-12 bg-primary text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-primary-hover hover:-translate-y-1 transition-all opacity-0 translate-y-4 pointer-events-none" title="Cuộn lên đầu trang">
            <span class="material-symbols-rounded">arrow_upward</span>
        </button>
    </main>

    <!-- ============================================== -->
    <!-- FILE EXPLORER MODAL                            -->
    <!-- ============================================== -->
    <div id="explorerModal" class="slide-up-modal fixed inset-0 z-[2000] bg-white hidden flex-col transform translate-y-full">
        <!-- Header -->
        <div class="h-16 border-b border-gray-200 flex items-center justify-between px-4 md:px-6 bg-[#f6f8fa] flex-shrink-0 z-10">
            <div class="flex items-center gap-4">
                <div class="bg-blue-100 text-blue-600 p-2 rounded-xl border border-blue-200">
                    <span class="material-symbols-rounded text-2xl">account_tree</span>
                </div>
                <div>
                    <h2 class="font-display font-medium text-gray-800 text-[15px] leading-tight flex items-center gap-2">
                        Duyệt Mã Nguồn <span id="explorerRepoName" class="text-primary font-bold bg-blue-50 px-2 py-0.5 rounded text-[13px] border border-blue-100"></span>
                    </h2>
                </div>
            </div>
            <button onclick="closeExplorerModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-200 rounded-xl transition-colors">
                <span class="hidden md:inline">Đóng</span>
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>

        <!-- Body: Split Screen -->
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden bg-white">
            <!-- Left Panel: File Tree -->
            <div class="w-full md:w-64 lg:w-80 h-[40%] md:h-full flex flex-col bg-[#f6f8fa] border-b md:border-b-0 md:border-r border-gray-200 flex-shrink-0">
                <div class="p-3 border-b border-gray-200 flex items-center gap-2 bg-white text-xs font-semibold text-gray-500 uppercase tracking-wider">
                    <span class="material-symbols-rounded text-[18px]">folder_copy</span> Cây thư mục
                </div>
                <div class="flex-1 overflow-y-auto p-2" id="fileTreeContainer">
                    <div class="flex justify-center mt-10 text-gray-400">
                        <div class="spinner !border-gray-300 !border-l-primary"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Code Viewer (ĐÃ ĐƯỢC CHUYỂN SANG LIGHT THEME) -->
            <div class="flex-1 h-[60%] md:h-full flex flex-col bg-white relative">
                <div class="h-12 border-b border-gray-200 bg-gray-50 flex items-center justify-between px-4">
                    <div class="flex items-center gap-2 text-sm text-gray-600 font-medium" id="codeViewerTitle">
                        <span class="material-symbols-rounded text-gray-500 text-[18px]">code</span> Chọn một file để xem
                    </div>
                    <button id="btnExplainFile" class="hidden items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white text-[13px] font-medium rounded-lg transition-all shadow-sm">
                        <span class="material-symbols-rounded text-[16px]">auto_awesome</span> Giải thích file này
                    </button>
                </div>
                
                <div class="flex-1 overflow-auto p-4 relative" id="codeViewerContent">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <span class="material-symbols-rounded text-6xl mb-4 opacity-30">data_object</span>
                        <p class="text-sm">Mã nguồn sẽ hiển thị tại đây</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================== -->

    <!-- ============================================== -->
    <!-- CỬA SỔ GIA SƯ TỪNG BƯỚC (TUTOR MODAL)          -->
    <!-- ============================================== -->
    <div id="tutorModal" class="slide-up-modal fixed inset-0 z-[2000] bg-white hidden flex-col transform translate-y-full">
        <div class="h-16 border-b border-gray-200 flex items-center justify-between px-4 md:px-6 bg-surface-light flex-shrink-0 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <div class="bg-primary/10 text-primary p-2 rounded-xl">
                    <span class="material-symbols-rounded text-2xl">model_training</span>
                </div>
                <div>
                    <h2 class="font-display font-medium text-gray-800 text-lg leading-tight" id="tutorModalTitle">Đang tải giáo án...</h2>
                    <p class="text-xs text-primary font-medium mt-0.5" id="tutorModalProgress">Bước 1 / 10</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- NÚT MỚI: YÊU CẦU KIẾN THỨC -->
                <button onclick="openPrerequisitesModal()" class="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-yellow-700 bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 rounded-lg transition-colors shadow-sm" title="Xem kiến thức & công cụ cần chuẩn bị">
                    <span class="material-symbols-rounded text-[16px] text-yellow-600">lightbulb</span>
                    <span class="hidden md:inline">Kiến thức cần có</span>
                </button>
                
                <!-- Nút Tạo Lại Giáo Án Mới -->
                <button onclick="regenerateTutorPlan()" class="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-orange-600 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg transition-colors shadow-sm" title="Tạo lại giáo án nếu nội dung AI sinh ra không chuẩn">
                    <span class="material-symbols-rounded text-[16px]">refresh</span>
                    <span class="hidden md:inline">Tạo lại</span>
                </button>
                <button onclick="closeTutorModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-xl transition-colors border border-transparent hover:border-red-100">
                    <span class="hidden md:inline">Đóng cửa sổ</span>
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col md:flex-row overflow-hidden bg-gray-50">
            <div class="w-full md:w-3/5 lg:w-2/3 h-[55%] md:h-full flex flex-col bg-white border-b md:border-b-0 md:border-r border-gray-200 relative shadow-[2px_0_10px_rgba(0,0,0,0.02)] z-10">
                <div class="flex-1 overflow-y-auto p-6 md:p-10 markdown-body" id="tutorStepContent"></div>
                <div class="p-4 border-t border-gray-100 bg-white flex items-center justify-between flex-shrink-0">
                    <button id="btnTutorPrev" class="px-4 py-2.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors flex items-center gap-1.5 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-rounded text-[18px]">arrow_back</span> <span class="hidden sm:inline">Trở lại</span>
                    </button>
                    <div class="flex gap-2">
                        <button id="btnTutorBug" class="px-4 py-2.5 text-sm font-medium text-orange-600 bg-white hover:bg-orange-50 border border-orange-200 rounded-xl transition-colors flex items-center gap-1.5 shadow-sm hover:shadow">
                            <span class="material-symbols-rounded text-[18px]">bug_report</span> <span class="hidden sm:inline">Gỡ lỗi bước này</span>
                        </button>
                        <button id="btnTutorNext" class="px-6 py-2.5 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors flex items-center gap-1.5 disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg">
                            <span>Tiếp theo</span> <span class="material-symbols-rounded text-[18px]">arrow_forward</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-2/5 lg:w-1/3 h-[45%] md:h-full flex flex-col bg-[#f8fafc]">
                <div class="p-3.5 border-b border-gray-200 bg-white flex items-center gap-2 flex-shrink-0 shadow-sm z-10">
                    <span class="material-symbols-rounded text-purple-500 text-lg">forum</span>
                    <h3 class="text-sm font-medium text-gray-700">Thảo luận & Hỏi đáp</h3>
                </div>
                <div id="tutorChatHistory" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3"></div>
                <div class="p-4 bg-white border-t border-gray-200 flex-shrink-0">
                    <div class="relative flex items-end bg-gray-50 border border-gray-300 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-primary/50 focus-within:border-primary transition-all">
                        <textarea id="tutorChatInput" rows="2" class="w-full bg-transparent border-none focus:ring-0 resize-none text-sm p-3 max-h-32" placeholder="Hỏi AI hoặc dán mã lỗi vào đây..."></textarea>
                        <button id="tutorChatSend" class="p-2.5 m-1.5 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors flex-shrink-0 flex items-center justify-center">
                            <span class="material-symbols-rounded text-[20px]">send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================== -->

    <!-- CÁC MODALS PHỤ -->
    
    <!-- MODAL MỚI: KIẾN THỨC CẦN CHUẨN BỊ -->
    <div id="prerequisitesModal" class="custom-modal-overlay fixed inset-0 bg-gray-900/60 z-[3000] flex items-center justify-center backdrop-blur-sm">
        <div class="custom-modal bg-white rounded-2xl p-0 w-[90%] max-w-lg shadow-2xl border border-gray-100 overflow-hidden flex flex-col max-h-[85vh]">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-yellow-50 to-amber-50 p-5 border-b border-amber-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm">
                    <span class="material-symbols-rounded text-amber-500 text-xl">lightbulb</span>
                </div>
                <div>
                    <h3 class="font-display text-lg font-semibold text-amber-900">Hành trang cần chuẩn bị</h3>
                    <p class="text-xs text-amber-700">Những kiến thức & công cụ cần có trước khi bắt đầu</p>
                </div>
            </div>
            
            <!-- Modal Body (Markdown) -->
            <div class="p-6 overflow-y-auto markdown-body !text-[14.5px]" id="prerequisitesContent">
                <!-- Nội dung AI sinh ra sẽ nằm ở đây -->
            </div>
            
            <!-- Modal Footer -->
            <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end">
                <button onclick="closePrerequisitesModal()" class="px-6 py-2.5 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors shadow-sm">
                    Đã hiểu, bắt đầu thôi!
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="custom-modal-overlay fixed inset-0 bg-gray-900/40 z-[9999] flex items-center justify-center backdrop-blur-sm">
        <div class="custom-modal bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <h3 class="font-display text-lg font-medium text-gray-800 mb-2">Xác nhận</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6 text-sm">Bạn có chắc chắn?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('confirmModal')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">Hủy</button>
                <button id="confirmYesBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-xl transition-colors shadow-sm">Đồng ý</button>
            </div>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div id="promptModal" class="custom-modal-overlay fixed inset-0 bg-gray-900/40 z-[9999] flex items-center justify-center backdrop-blur-sm">
        <div class="custom-modal bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <h3 id="promptTitle" class="font-display text-lg font-medium text-gray-800 mb-4">Nhập thông tin</h3>
            <input type="text" id="promptInputVal" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm text-gray-800 mb-6" autocomplete="off">
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('promptModal')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">Hủy</button>
                <button id="promptYesBtn" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors shadow-sm">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="custom-modal-overlay show fixed inset-0 bg-gray-900/60 z-[4000] flex items-center justify-center backdrop-blur-md">
        <div class="custom-modal bg-white rounded-3xl p-8 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary">
                    <span class="material-symbols-rounded text-3xl">cloud_sync</span>
                </div>
                <h3 class="font-display text-2xl font-medium text-gray-800 mb-2">Đồng bộ Đám mây</h3>
                <p class="text-gray-500 text-sm">Đăng nhập để tự động lưu và đồng bộ lịch sử học tập của bạn qua Firestore.</p>
            </div>
            <div id="authError" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-xl mb-4 border border-red-100 font-medium text-center"></div>
            <div class="space-y-4 mb-8">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1 ml-1">Email</label>
                    <input type="email" id="authEmail" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm" placeholder="user@email.com">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1 ml-1">Mật khẩu</label>
                    <input type="password" id="authPassword" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm" placeholder="Ít nhất 6 ký tự">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="registerUser()" class="flex-1 py-3 text-sm font-medium text-primary bg-blue-50 hover:bg-blue-100 rounded-xl transition-colors border border-blue-100">Tạo tài khoản</button>
                <button onclick="loginUser()" class="flex-1 py-3 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors shadow-md hover:shadow-lg">Đăng nhập</button>
            </div>
        </div>
    </div>

    <!-- LOGIC JS -->
    <script type="module">
        if (typeof AbortSignal !== 'undefined' && !AbortSignal.any) {
            AbortSignal.any = function(signals) {
                const controller = new AbortController();
                for (const signal of signals) {
                    if (signal.aborted) {
                        controller.abort(signal.reason);
                        return controller.signal;
                    }
                    signal.addEventListener('abort', () => controller.abort(signal.reason), { once: true });
                }
                return controller.signal;
            };
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-ai.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAtoX3PysX692bNg6nA55Qriv5P-7phmFQ",
          authDomain: "aiminh-d96d4.firebaseapp.com",
          projectId: "aiminh-d96d4",
          storageBucket: "aiminh-d96d4.firebasestorage.app",
          messagingSenderId: "159603803322",
          appId: "1:159603803322:web:3693589412fca5c3456e83"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const statusMessage = document.getElementById('statusMessage');

        let currentRepoId = null; 
        let sessionHistory = []; 
        let currentRepoIndex = ""; 
        let activeTemplateType = "custom"; 

        // Biến lưu Repo Path cho File Explorer
        let currentGithubRepoPath = ""; 

        // Biến lưu trữ Giáo án và Kiến thức
        let tutorSteps = [];
        let currentTutorStepIndex = 0;
        let tutorPrerequisites = ""; // Lưu kiến thức cần có (Dạng Markdown)

        const emptyStateContainer = document.getElementById('emptyStateContainer');
        const chatHistoryContainer = document.getElementById('chatHistoryContainer');
        const historyList = document.getElementById('historyList');
        const quickActions = document.getElementById('quickActions');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const mainContentElement = document.getElementById('main-content');
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');
        const btnOpenExplorer = document.getElementById('btnOpenExplorer');
        const btnResumeTutor = document.getElementById('btnResumeTutor');

        mainContentElement.addEventListener('scroll', () => {
            if (mainContentElement.scrollTop > 300) {
                scrollToTopBtn.classList.add('show-scroll-btn');
            } else {
                scrollToTopBtn.classList.remove('show-scroll-btn');
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            mainContentElement.scrollTo({ top: 0, behavior: 'smooth' });
        });

        window.clearRepoIndex = function() {
            currentRepoId = null;
            currentRepoIndex = "";
            currentGithubRepoPath = "";
            sessionHistory = [];
            
            // Xóa state của giáo án
            tutorSteps = [];
            currentTutorStepIndex = 0;
            tutorPrerequisites = "";
            btnResumeTutor.classList.add('hidden');
            btnResumeTutor.classList.remove('flex');
            
            document.getElementById('repoContextBadge').classList.add('hidden');
            quickActions.classList.add('hidden');
            btnOpenExplorer.classList.add('hidden'); 
            btnOpenExplorer.classList.remove('flex');
            chatHistoryContainer.innerHTML = '';
            emptyStateContainer.classList.remove('hidden'); 
            updateStatus('text-blue-600', "Đã tạo phiên học mới.");
        };

        // --- LOGIC AUTH ---
        const authModal = document.getElementById('authModal');
        const authError = document.getElementById('authError');
        
        function showAuthError(msg) { authError.textContent = msg; authError.classList.remove('hidden'); }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authModal.classList.remove('show');
                document.getElementById('userInfoDisplay').classList.remove('hidden');
                document.getElementById('userAvatar').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                updateStatus('text-blue-600', "Đã kết nối đám mây. Đang tải dữ liệu...");
                loadHistory(); 
            } else {
                authModal.classList.add('show');
                document.getElementById('userInfoDisplay').classList.add('hidden');
                document.getElementById('userAvatar').classList.add('hidden');
                historyList.innerHTML = `<div class="text-center py-6"><span class="material-symbols-rounded text-gray-300 text-3xl mb-2">lock</span><p class="text-xs text-gray-400">Vui lòng đăng nhập.</p></div>`;
                clearRepoIndex(); 
            }
        });

        window.loginUser = async function() {
            try {
                showAuthError("Đang đăng nhập...");
                await signInWithEmailAndPassword(auth, document.getElementById('authEmail').value, document.getElementById('authPassword').value);
            } catch (error) { showAuthError("Lỗi đăng nhập: " + error.message); }
        };

        window.registerUser = async function() {
            try {
                showAuthError("Đang tạo tài khoản...");
                await createUserWithEmailAndPassword(auth, document.getElementById('authEmail').value, document.getElementById('authPassword').value);
            } catch (error) { showAuthError("Lỗi đăng ký: " + error.message); }
        };

        window.logoutUser = async function() { await signOut(auth); };

        window.closeModal = function(modalId) { document.getElementById(modalId).classList.remove('show'); }

        function showCustomConfirm(message, onConfirm) {
            document.getElementById('confirmMessage').innerText = message;
            document.getElementById('confirmModal').classList.add('show');
            document.getElementById('confirmYesBtn').onclick = function() { closeModal('confirmModal'); onConfirm(); };
        }

        function showCustomPrompt(title, defaultVal, onConfirm) {
            document.getElementById('promptTitle').innerText = title;
            const inputField = document.getElementById('promptInputVal');
            inputField.value = defaultVal;
            document.getElementById('promptModal').classList.add('show');
            inputField.focus();
            document.getElementById('promptYesBtn').onclick = function() { closeModal('promptModal'); onConfirm(inputField.value); };
            inputField.onkeydown = function(e) { if (e.key === 'Enter') document.getElementById('promptYesBtn').click(); }
        }

        let currentUserRepos = [];

        async function loadHistory() {
            if (!auth.currentUser) return;
            const q = query(collection(db, `users/${auth.currentUser.uid}/repos`), orderBy("updatedAt", "desc"));
            try {
                const querySnapshot = await getDocs(q);
                currentUserRepos = [];
                historyList.innerHTML = "";
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = `<div class="text-center py-6"><p class="text-xs text-gray-400">Chưa có dự án nào.</p></div>`;
                    return;
                }
                
                querySnapshot.forEach(docSnap => {
                    const repo = { id: docSnap.id, ...docSnap.data() };
                    currentUserRepos.push(repo);
                    const dateStr = new Date(repo.updatedAt).toLocaleString('vi-VN', {hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
                    const item = document.createElement('div');
                    item.className = 'group flex items-center justify-between p-3 rounded-xl border border-transparent bg-gray-50 hover:bg-blue-50 hover:border-blue-100 cursor-pointer transition-all mb-2';
                    item.innerHTML = `
                        <div style="overflow: hidden; flex-grow: 1;" onclick="viewRepo('${repo.id}')">
                            <div class="text-sm font-medium text-gray-700 truncate">${repo.title}</div>
                            <div class="text-[11px] text-gray-500 mt-0.5">${repo.history.length} mục • ${dateStr}</div>
                        </div>
                        <button class="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" onclick="deleteRepo('${repo.id}', event)" title="Xóa">
                            <span class="material-symbols-rounded text-[18px]">delete</span>
                        </button>
                    `;
                    historyList.appendChild(item);
                });
            } catch (error) { updateStatus('text-red-600', "Lỗi tải dữ liệu. Kiểm tra Rules."); }
        }

        window.viewRepo = function(id) {
            const repo = currentUserRepos.find(r => r.id === id);
            if(repo) {
                currentRepoId = repo.id;
                currentRepoIndex = repo.repoIndex || "";
                sessionHistory = repo.history || [];
                currentGithubRepoPath = repo.githubPath || "";
                
                // Phục hồi trạng thái giáo án từ Firestore (nếu có)
                tutorSteps = repo.tutorSteps || [];
                currentTutorStepIndex = repo.currentTutorStepIndex || 0;
                tutorPrerequisites = repo.tutorPrerequisites || ""; // Khôi phục cả hành trang
                
                renderChatHistory(); 
                
                if (currentRepoIndex !== "") {
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }
                if (currentGithubRepoPath !== "") {
                    btnOpenExplorer.classList.remove('hidden');
                    btnOpenExplorer.classList.add('flex');
                    document.getElementById('repoContextSubtext').innerText = currentGithubRepoPath;
                }
                
                quickActions.classList.remove('hidden');
                
                // Hiện nút Tiếp tục học nếu có giáo án
                if (tutorSteps.length > 0) {
                    btnResumeTutor.classList.remove('hidden');
                    btnResumeTutor.classList.add('flex');
                } else {
                    btnResumeTutor.classList.add('hidden');
                    btnResumeTutor.classList.remove('flex');
                }
                
                updateStatus('text-blue-600', `Đang học dự án: ${repo.title}`);
                if(window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
            }
        };

        window.deleteRepo = function(id, event) {
            event.stopPropagation();
            showCustomConfirm("Xóa dự án này trên đám mây?", async () => {
                await deleteDoc(doc(db, `users/${auth.currentUser.uid}/repos`, id));
                if (currentRepoId === id) clearRepoIndex(); 
                loadHistory();
            });
        };

        function extractRepoFromPrompt(promptText) {
            const githubRegex = /github\.com\/([^/\s]+\/[^/\s]+)/i;
            const match = promptText.match(githubRegex);
            if (match && match[1]) {
                return match[1].replace('.git', '');
            }
            return "";
        }

        function extractDefaultTitle(promptText) {
            const path = extractRepoFromPrompt(promptText);
            if (path) return "Repo: " + path;
            
            const lines = promptText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const lastLine = lines[lines.length - 1];
            if (lastLine && !lastLine.includes("DÁN LINK") && !lastLine.includes("Hãy đóng vai")) {
                return "Dự án: " + (lastLine.length > 25 ? lastLine.substring(0, 25) + "..." : lastLine);
            }
            return "Dự án Lập trình mới";
        }

        async function autoSaveRepo() {
            if (!auth.currentUser || sessionHistory.length === 0) return;
            const reposRef = collection(db, `users/${auth.currentUser.uid}/repos`);

            if (currentRepoId === null) {
                let defaultTitle = extractDefaultTitle(sessionHistory[0].prompt);
                showCustomPrompt("Đặt tên dự án để lưu lên đám mây:", defaultTitle, async (title) => {
                    if (title.trim() === "") title = defaultTitle;
                    const newRepoRef = doc(reposRef);
                    currentRepoId = newRepoRef.id; 
                    await setDoc(newRepoRef, {
                        title: title, 
                        repoIndex: currentRepoIndex, 
                        githubPath: currentGithubRepoPath,
                        history: sessionHistory, 
                        tutorSteps: tutorSteps,                     
                        currentTutorStepIndex: currentTutorStepIndex,
                        tutorPrerequisites: tutorPrerequisites,     // Lưu kiến thức cần có
                        updatedAt: new Date().getTime()
                    });
                    loadHistory();
                });
            } else {
                const repoRef = doc(db, `users/${auth.currentUser.uid}/repos`, currentRepoId);
                await setDoc(repoRef, {
                    repoIndex: currentRepoIndex, 
                    githubPath: currentGithubRepoPath,
                    history: sessionHistory, 
                    tutorSteps: tutorSteps,                     
                    currentTutorStepIndex: currentTutorStepIndex,
                    tutorPrerequisites: tutorPrerequisites,     // Cập nhật kiến thức cần có
                    updatedAt: new Date().getTime()
                }, { merge: true }); 
                loadHistory();
            }
        }

        // HÀM MỚI: Rút gọn code khi hiển thị câu hỏi của người dùng
        function formatUserMessage(text) {
            // Nhận diện prompt chứa code từ File Explorer
            if (text.includes('[MÃ NGUỒN FILE]:')) {
                const parts = text.split('[MÃ NGUỒN FILE]:');
                const instruction = parts[0].trim();
                let codePart = parts[1].trim();
                
                // Cắt bỏ dấu markdown ``` nếu có để lấy code thuần
                if(codePart.startsWith('```')) {
                    const firstNewline = codePart.indexOf('\n');
                    const lastBackticks = codePart.lastIndexOf('```');
                    if(firstNewline !== -1 && lastBackticks !== -1) {
                        codePart = codePart.substring(firstNewline + 1, lastBackticks).trim();
                    }
                }
                
                // Trích xuất ~30 ký tự đầu tiên
                const preview = codePart.substring(0, 30).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '...';
                
                return `${instruction}<br><br>
                <div class="bg-white border border-blue-200 rounded-xl overflow-hidden mt-2 shadow-sm w-full">
                    <div class="bg-blue-50 px-3 py-2 flex items-center justify-between cursor-pointer hover:bg-blue-100 transition-colors" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <div class="flex items-center gap-2 text-blue-700 text-[13px] font-semibold">
                            <span class="material-symbols-rounded text-[18px]">data_object</span>
                            <span>Mã nguồn: ${preview}</span>
                        </div>
                        <span class="text-[10px] bg-white border border-blue-200 px-2 py-0.5 rounded-full text-blue-600 shadow-sm whitespace-nowrap">Nhấn xem chi tiết</span>
                    </div>
                    <div class="hidden p-3 bg-gray-50 text-[12px] font-mono text-gray-600 max-h-[300px] overflow-y-auto whitespace-pre-wrap border-t border-blue-100">
                        ${codePart.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                </div>`;
            }
            return text;
        }

        // --- RENDER GIAO DIỆN CHAT ---
        function renderChatHistory(isNewMessage = false) {
            emptyStateContainer.classList.add('hidden'); 
            chatHistoryContainer.innerHTML = "";
            
            sessionHistory.forEach(item => {
                const block = document.createElement('div');
                block.className = 'mb-8 pb-6 border-b border-gray-100 last:border-0 chat-block';
                block.innerHTML = `
                    <div class="bg-blue-50/50 p-4 rounded-2xl rounded-tr-sm border border-blue-100/50 text-gray-800 font-medium mb-5 text-[15px] whitespace-pre-wrap flex gap-3 shadow-sm">
                        <span class="material-symbols-rounded text-primary flex-shrink-0 mt-0.5">person</span>
                        <div class="leading-relaxed w-full">${formatUserMessage(item.prompt)}</div>
                    </div>
                    <div class="markdown-body !text-[15px] leading-relaxed text-gray-800">
                        ${marked.parse(item.response)}
                    </div>
                `;
                chatHistoryContainer.appendChild(block);
            });

            if (isNewMessage) {
                const lastBlock = chatHistoryContainer.lastElementChild;
                if (lastBlock) setTimeout(() => lastBlock.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50); 
            } else {
                mainContentElement.scrollTop = mainContentElement.scrollHeight;
            }
        }

        document.getElementById('btnGotBug').addEventListener('click', () => {
            promptInput.value = "Tôi gặp lỗi ở bước này. Lý do có thể là gì và làm sao để kiểm tra/khắc phục? Đây là mã lỗi tôi thấy:\n[DÁN MÃ LỖI VÀO ĐÂY]";
            promptInput.focus();
            if(window.innerWidth <= 768 && !document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        });
        
        // Mở lại giáo án cũ đang học dở
        btnResumeTutor.addEventListener('click', () => {
            if (tutorSteps.length > 0) openTutorModal();
        });

        // --- COPY CODE ---
        document.addEventListener('click', function(e) {
            const copyBtn = e.target.closest('.copy-btn');
            if (!copyBtn) return;
            const codeToCopy = decodeURIComponent(copyBtn.getAttribute('data-code'));
            const textArea = document.createElement("textarea");
            textArea.value = codeToCopy;
            textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                if (document.execCommand('copy')) {
                    const icon = copyBtn.querySelector('.material-symbols-rounded');
                    const text = copyBtn.querySelector('.copy-text');
                    const originalIcon = icon.innerText, originalText = text.innerText;
                    icon.innerText = 'check'; icon.classList.add('text-green-500');
                    text.innerText = 'Đã chép!'; text.classList.add('text-green-500');
                    setTimeout(() => {
                        icon.innerText = originalIcon; icon.classList.remove('text-green-500');
                        text.innerText = originalText; text.classList.remove('text-green-500');
                    }, 2000);
                }
            } catch (err) { console.error('Lỗi copy', err); }
            document.body.removeChild(textArea);
        });

        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            if(sidebar.classList.contains('open')) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('opacity-100'), 10);
            } else {
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }
        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        function updateStatus(colorClass, message) {
            statusMessage.className = `text-xs text-center font-medium mt-1 px-2 transition-colors ${colorClass}`;
            statusMessage.innerHTML = message; 
        }

        const renderer = new marked.Renderer();
        renderer.code = function(codeOrToken, language) {
            let code = codeOrToken, lang = language;
            if (typeof codeOrToken === 'object') { code = codeOrToken.text; lang = codeOrToken.lang; }
            const validLang = (lang && hljs.getLanguage(lang)) ? lang : 'plaintext';
            const highlighted = validLang === 'plaintext' ? hljs.highlightAuto(code).value : hljs.highlight(code, { language: validLang }).value;
            const encodedCode = encodeURIComponent(code); 
            
            // Xử lý đếm dòng, nếu code dài thì cho thanh cuộn thay vì kéo dài lê thê
            const lineCount = code.split('\n').length;
            const isLongCode = lineCount > 15;
            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
            
            return `
            <div class="code-block-wrapper rounded-xl overflow-hidden bg-white border border-gray-200 my-5 shadow-[0_2px_8px_rgba(0,0,0,0.04)] text-left">
                <div class="flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-200">
                    <span class="text-[11px] font-semibold text-gray-500 uppercase tracking-wider flex items-center gap-1.5"><span class="material-symbols-rounded text-[14px]">code</span>${validLang}</span>
                    <div class="flex items-center gap-2">
                        ${isLongCode ? `<button onclick="document.getElementById('${codeId}').classList.toggle('max-h-[300px]'); this.innerText = this.innerText === 'Mở rộng toàn bộ' ? 'Thu gọn' : 'Mở rộng toàn bộ';" class="text-[11px] font-medium text-primary hover:bg-blue-50 border border-transparent hover:border-blue-100 px-2 py-1.5 rounded transition-all">Mở rộng toàn bộ</button>` : ''}
                        <button class="copy-btn flex items-center gap-1.5 text-[11px] font-medium text-gray-600 bg-white border border-gray-200 hover:bg-gray-100 px-2.5 py-1.5 rounded-lg shadow-sm transition-all focus:outline-none" data-code="${encodedCode}">
                            <span class="material-symbols-rounded text-[14px]">content_copy</span> <span class="copy-text">Sao chép</span>
                        </button>
                    </div>
                </div>
                <div id="${codeId}" class="p-4 overflow-x-auto text-[14px] bg-[#f8f9fa] ${isLongCode ? 'max-h-[300px] overflow-y-auto' : ''}">
                    <pre class="!m-0 !bg-transparent !p-0"><code class="hljs language-${validLang} !text-gray-800 !bg-transparent">${highlighted}</code></pre>
                </div>
            </div>`;
        };
        marked.use({ renderer });

        // --- GITHUB EXPLORER LOGIC ---
        let currentViewingFileName = "";
        let currentViewingFileContent = "";

        window.openExplorerModal = function() {
            if (!currentGithubRepoPath) { alert("Không tìm thấy thông tin repository."); return; }
            const modal = document.getElementById('explorerModal');
            document.getElementById('explorerRepoName').innerText = currentGithubRepoPath;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => { modal.classList.remove('translate-y-full'); }, 10);
            fetchGitHubContents("");
        };

        window.closeExplorerModal = function() {
            const modal = document.getElementById('explorerModal');
            modal.classList.add('translate-y-full');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        };

        async function fetchGitHubContents(path, parentElement = document.getElementById('fileTreeContainer')) {
            try {
                if(path === "") parentElement.innerHTML = `<div class="flex justify-center mt-10 text-gray-400"><div class="spinner !border-gray-300 !border-l-primary"></div></div>`;
                const response = await fetch(`https://api.github.com/repos/${currentGithubRepoPath}/contents/${path}`);
                if (!response.ok) throw new Error("API rate limit hoặc repo private.");
                const data = await response.json();
                
                data.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === "dir" ? -1 : 1;
                });

                let html = "";
                data.forEach(item => {
                    if (item.type === "dir") {
                        html += `
                        <div>
                            <div class="tree-item" onclick="toggleFolder(this, '${item.path}')">
                                <span class="material-symbols-rounded tree-icon text-blue-400">folder</span>
                                <span>${item.name}</span>
                            </div>
                            <div class="tree-children" id="folder-${btoa(item.path).replace(/=/g, '')}"></div>
                        </div>`;
                    } else if (item.type === "file") {
                        html += `
                        <div class="tree-item" onclick="viewGitHubFile(this, '${item.path}', '${item.download_url}')">
                            <span class="material-symbols-rounded tree-icon text-gray-400">description</span>
                            <span class="truncate">${item.name}</span>
                        </div>`;
                    }
                });
                parentElement.innerHTML = html;
            } catch (error) {
                parentElement.innerHTML = `<div class="p-3 text-red-500 text-sm">Lỗi tải dữ liệu. Cấu trúc repo có thể bị giới hạn API.</div>`;
            }
        }

        window.toggleFolder = function(element, path) {
            const childrenContainer = document.getElementById(`folder-${btoa(path).replace(/=/g, '')}`);
            if (childrenContainer.classList.contains('open')) {
                childrenContainer.classList.remove('open');
                element.querySelector('.tree-icon').innerText = 'folder';
            } else {
                childrenContainer.classList.add('open');
                element.querySelector('.tree-icon').innerText = 'folder_open';
                if (childrenContainer.innerHTML === "") {
                    childrenContainer.innerHTML = `<div class="text-xs text-gray-400 my-2 ml-2">Đang tải...</div>`;
                    fetchGitHubContents(path, childrenContainer);
                }
            }
        };

        window.viewGitHubFile = async function(element, path, downloadUrl) {
            document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            const contentContainer = document.getElementById('codeViewerContent');
            const titleContainer = document.getElementById('codeViewerTitle');
            const btnExplain = document.getElementById('btnExplainFile');
            
            const fileName = path.split('/').pop();
            titleContainer.innerHTML = `<span class="material-symbols-rounded text-gray-500 text-[18px]">description</span> ${path}`;
            btnExplain.classList.add('hidden'); 
            
            contentContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400"><div class="spinner mb-4 !border-gray-300 !border-l-primary"></div><p class="text-sm">Đang tải nội dung file...</p></div>`;

            try {
                const response = await fetch(downloadUrl);
                if (!response.ok) throw new Error("Không thể đọc file");
                const text = await response.text();
                
                if (text.length > 100000) {
                    contentContainer.innerHTML = `<div class="text-red-400 p-4">File quá lớn để hiển thị hoặc định dạng không hỗ trợ.</div>`;
                    return;
                }

                currentViewingFileName = fileName;
                currentViewingFileContent = text;

                const ext = fileName.split('.').pop();
                let validLang = hljs.getLanguage(ext) ? ext : 'plaintext';
                if(['js', 'jsx'].includes(ext)) validLang = 'javascript';
                if(['ts', 'tsx'].includes(ext)) validLang = 'typescript';
                if(ext === 'py') validLang = 'python';
                if(ext === 'html') validLang = 'xml';

                const highlighted = validLang === 'plaintext' ? hljs.highlightAuto(text).value : hljs.highlight(text, { language: validLang }).value;

                contentContainer.innerHTML = `<pre class="!m-0 !bg-transparent !p-0"><code class="hljs language-${validLang} !text-gray-800 !bg-transparent">${highlighted}</code></pre>`;
                btnExplain.classList.remove('hidden');
                btnExplain.classList.add('flex');
            } catch (error) {
                contentContainer.innerHTML = `<div class="text-red-400 p-4">Lỗi tải nội dung: File có thể là định dạng ảnh hoặc nhị phân.</div>`;
            }
        };

        document.getElementById('btnExplainFile').addEventListener('click', () => {
            if(!currentViewingFileName || !currentViewingFileContent) return;
            const promptText = `Hệ thống vừa trích xuất mã nguồn của file \`${currentViewingFileName}\` trong dự án.\n\nHãy giải thích chi tiết chức năng, luồng hoạt động của file này.\n\n[MÃ NGUỒN FILE]:\n\`\`\`\n${currentViewingFileContent}\n\`\`\``;
            closeExplorerModal();
            promptInput.value = promptText;
            updateStatus('text-blue-600', "Đang gửi file cho AI...");
            setTimeout(() => sendPromptButton.click(), 300); 
        });

        // --- LOGIC MODAL: KIẾN THỨC CẦN CHUẨN BỊ ---
        window.openPrerequisitesModal = function() {
            const content = tutorPrerequisites && tutorPrerequisites.trim() !== "" 
                ? tutorPrerequisites 
                : "Không có yêu cầu đặc biệt nào được gợi ý cho dự án này.";
            
            document.getElementById('prerequisitesContent').innerHTML = marked.parse(content);
            document.getElementById('prerequisitesModal').classList.add('show');
        };

        window.closePrerequisitesModal = function() {
            document.getElementById('prerequisitesModal').classList.remove('show');
        };

        // --- CÁC HÀM XỬ LÝ GIA SƯ TỪNG BƯỚC (TUTOR) ---
        function parseTutorSteps(text) {
            const steps = [];
            const blocks = text.split('===STEP_START===');
            for (let i = 1; i < blocks.length; i++) {
                const block = blocks[i];
                const endIdx = block.indexOf('===STEP_END===');
                let contentStr = endIdx !== -1 ? block.substring(0, endIdx).trim() : block.trim();
                let title = `Bước ${i}`;
                const titleMatch = contentStr.match(/TIÊU ĐỀ:\s*(.*)/);
                if (titleMatch) { title = titleMatch[1].trim(); contentStr = contentStr.replace(titleMatch[0], '').trim(); }
                const contentMatch = contentStr.match(/NỘI DUNG:\s*([\s\S]*)/);
                if (contentMatch) { contentStr = contentMatch[1].trim(); }
                steps.push({ title, content: contentStr });
            }
            return steps;
        }

        window.closeTutorModal = function() {
            const modal = document.getElementById('tutorModal');
            modal.classList.add('translate-y-full');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        }

        function openTutorModal(isFirstTime = false) {
            const modal = document.getElementById('tutorModal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { modal.classList.remove('translate-y-full'); }, 10);
            renderTutorStep();
            
            if (isFirstTime) {
                setTimeout(() => {
                    openPrerequisitesModal();
                }, 400); 
            }
        }
        
        window.regenerateTutorPlan = function() {
            showCustomConfirm("Giáo án cũ sẽ bị xóa. Bạn có muốn AI tạo lại giáo án mới không?", () => {
                closeTutorModal();
                setTemplate('tutor'); 
                setTimeout(() => { sendPromptButton.click(); }, 300); 
            });
        };

        function renderTutorStep() {
            const step = tutorSteps[currentTutorStepIndex];
            document.getElementById('tutorModalTitle').innerText = step.title;
            document.getElementById('tutorModalProgress').innerText = `Bước ${currentTutorStepIndex + 1} / ${tutorSteps.length}`;
            document.getElementById('tutorStepContent').innerHTML = marked.parse(step.content);
            document.getElementById('tutorStepContent').scrollTop = 0;
            document.getElementById('btnTutorPrev').disabled = (currentTutorStepIndex === 0);
            const nextBtn = document.getElementById('btnTutorNext');
            if (currentTutorStepIndex === tutorSteps.length - 1) {
                nextBtn.innerHTML = 'Hoàn thành <span class="material-symbols-rounded text-[18px]">done_all</span>';
            } else { nextBtn.innerHTML = 'Tiếp theo <span class="material-symbols-rounded text-[18px]">arrow_forward</span>'; }
            
            document.getElementById('tutorChatHistory').innerHTML = `<div class="text-center text-xs text-gray-400 my-auto bg-white p-4 rounded-2xl border border-dashed border-gray-200 mx-4"><span class="material-symbols-rounded text-gray-300 text-3xl mb-2 block">live_help</span>Nếu không hiểu code hoặc gặp lỗi ở bước này, hãy hỏi AI tại đây!</div>`;
            document.getElementById('tutorChatInput').value = '';
        }

        document.getElementById('btnTutorPrev').addEventListener('click', () => { 
            if (currentTutorStepIndex > 0) { currentTutorStepIndex--; renderTutorStep(); autoSaveRepo(); } 
        });
        document.getElementById('btnTutorNext').addEventListener('click', () => {
            if (currentTutorStepIndex < tutorSteps.length - 1) { 
                currentTutorStepIndex++; renderTutorStep(); autoSaveRepo(); 
            } 
            else { closeTutorModal(); updateStatus('text-green-600', 'Chúc mừng bạn đã hoàn thành giáo án!'); }
        });
        
        document.getElementById('btnTutorBug').addEventListener('click', () => {
            document.getElementById('tutorChatInput').value = "Tôi gặp lỗi ở bước này. Lý do có thể là gì và làm sao để kiểm tra/khắc phục? Đây là mã lỗi tôi thấy:\n";
            document.getElementById('tutorChatInput').focus();
        });

        document.getElementById('tutorChatSend').addEventListener('click', async () => {
            const input = document.getElementById('tutorChatInput');
            const userText = input.value.trim();
            if(!userText || !model) return;
            const historyDiv = document.getElementById('tutorChatHistory');
            if (historyDiv.innerHTML.includes('đặt câu hỏi về bước này')) historyDiv.innerHTML = '';
            historyDiv.innerHTML += `<div class="bg-blue-100 text-blue-900 p-3 rounded-xl rounded-br-sm text-[13px] ml-auto max-w-[90%] mb-3 shadow-sm break-words whitespace-pre-wrap font-medium border border-blue-200">${userText}</div>`;
            input.value = '';
            const loadingId = 'loading-' + Date.now();
            historyDiv.innerHTML += `<div id="${loadingId}" class="bg-white border border-gray-200 text-gray-600 p-3 rounded-xl rounded-bl-sm text-[13px] mr-auto max-w-[85%] mb-3 flex items-center gap-2 shadow-sm"><div class="spinner !w-4 !h-4 !border-2 border-gray-300 border-l-primary"></div> Đang trả lời...</div>`;
            historyDiv.scrollTop = historyDiv.scrollHeight;
            const stepContent = tutorSteps[currentTutorStepIndex].content;
            const promptContext = `[NGỮ CẢNH DỰ ÁN]:\n${currentRepoIndex}\n\n[BƯỚC BẠN ĐANG HƯỚNG DẪN TÔI]:\n${stepContent}\n\n[CÂU HỎI CỦA TÔI]:\n${userText}\n\nLưu ý: Chỉ trả lời tập trung vào câu hỏi liên quan đến bước này, giải thích dễ hiểu cho newbie.`;
            try {
                const result = await model.generateContent(promptContext);
                const text = result.response.text();
                document.getElementById(loadingId).remove();
                historyDiv.innerHTML += `<div class="bg-white border border-gray-200 text-gray-800 p-4 rounded-xl rounded-bl-sm mr-auto w-full mb-3 shadow-sm markdown-body !text-[13.5px]">${marked.parse(text)}</div>`;
                historyDiv.scrollTop = historyDiv.scrollHeight;
            } catch(e) {
                document.getElementById(loadingId).remove();
                historyDiv.innerHTML += `<div class="bg-red-50 text-red-600 border border-red-100 p-3 rounded-xl rounded-bl-sm text-[13px] mr-auto max-w-[85%] mb-3 shadow-sm font-medium">Lỗi kết nối: ${e.message}</div>`;
            }
        });

        // --- GEMINI API CALL (ĐÃ CẬP NHẬT CHỐNG ẢO GIÁC BẰNG FILE TREE) ---
        const systemPrompt = `You are an AI Technical Tutor. Turn any GitHub repository into a beginner-friendly tutorial. Assume user is a beginner. Never skip steps. Explain before showing code.`;
        let model;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash", systemInstruction: systemPrompt });
            updateStatus('text-green-600', "AI Tutor đã sẵn sàng.");
        } catch (e) { updateStatus('text-red-600', `Lỗi AI: ${e.message}`); }

        const templates = {
            explain: "Hãy đóng vai một chuyên gia lập trình. Đọc repository dưới đây và tạo ra một bản tóm tắt kiến trúc dự án, luồng hoạt động chính và các file quan trọng. Giải thích cho tôi hiểu như một người mới bắt đầu.\n\n[DÁN LINK GITHUB HOẶC MÃ NGUỒN VÀO ĐÂY]",
            tutor: "Hãy tạo một lộ trình giáo án thực hành dự án này. Chia thành các bước nhỏ (tối đa 10 bước). \n\nYÊU CẦU 1: Bắt buộc liệt kê các kiến thức, ngôn ngữ, phần mềm hoặc công cụ cần cài đặt trước khi học dự án này. Bọc trong khối PREREQ_START và PREREQ_END như mẫu dưới đây.\n\nYÊU CẦU 2: Trả về kết quả CHÍNH XÁC theo định dạng mẫu dưới đây để hệ thống tôi phân tách:\n\n===PREREQ_START===\n[Liệt kê chi tiết các công cụ, ngôn ngữ, IDE cần thiết để chạy dự án]\n===PREREQ_END===\n\n===STEP_START===\nTIÊU ĐỀ: [Tên bước 1]\nNỘI DUNG:\n[Giải thích chi tiết và mã code của bước 1]\n===STEP_END===\n\n===STEP_START===\nTIÊU ĐỀ: [Tên bước 2]\nNỘI DUNG:\n[Giải thích chi tiết và mã code của bước 2]\n===STEP_END===\n\n(Tiếp tục cho đến hết. Lưu ý: CHỈ trả về các khối PREREQ và STEP, không cần phần chào hỏi).",
            debug: "Tôi nhận được thông báo lỗi này trong quá trình làm. Hãy giải thích bằng ngôn ngữ đơn giản tại sao lại bị lỗi và cách khắc phục.\n[DÁN LOG LỖI VÀO ĐÂY]",
            customize: "Tôi muốn tùy chỉnh dự án này cho mục đích cá nhân của mình:\n[ĐIỀN MỤC TIÊU CỦA BẠN VÀO ĐÂY]\n\nHãy giải thích những gì tôi cần thay đổi trong mã nguồn.",
            deploy: "Hãy hướng dẫn tôi cách triển khai (deploy) dự án này lên mạng.\nCứ giả định rằng tôi chưa từng deploy bất cứ thứ gì trước đây.\nHãy giải thích cặn kẽ từng bước."
        };

        window.setTemplate = function(type) {
            activeTemplateType = type; promptInput.value = templates[type]; promptInput.focus();
            if(window.innerWidth <= 768 && sidebar.classList.contains('open')) { /* toggleSidebar(); */ }
        };

        async function callGeminiAPI() {
            if (!model) return updateStatus('text-red-600', "Mô hình AI lỗi.");
            const promptText = promptInput.value.trim();
            if (!promptText) return updateStatus('text-red-600', "Vui lòng nhập lời nhắc!");

            updateStatus('text-blue-600', "Đang phân tích yêu cầu...");
            quickActions.classList.add('hidden'); emptyStateContainer.classList.add('hidden'); loadingIndicator.classList.remove('hidden');
            buttonText.textContent = 'Đang xử lý...'; buttonSpinner.classList.remove('hidden'); sendPromptButton.disabled = true;

            if(window.innerWidth <= 768 && sidebar.classList.contains('open')) toggleSidebar();

            let finalPrompt = promptText;
            
            // =========================================================
            // GIẢI PHÁP CHỐNG ẢO GIÁC (HALLUCINATION) KHI NHẬP LINK GITHUB
            // Tự động kéo file README.md VÀ Cấu trúc thư mục gốc từ Github
            // =========================================================
            const extractedPath = extractRepoFromPrompt(promptText);
            if (extractedPath && activeTemplateType === 'explain') {
                try {
                    updateStatus('text-blue-600', "Đang tải cấu trúc & dữ liệu thực từ GitHub...");
                    
                    let repoStructure = "";
                    let readmeContent = "";

                    // 1. Fetch Root Directory Structure
                    try {
                        const contentsRes = await fetch(`https://api.github.com/repos/${extractedPath}/contents/`);
                        if (contentsRes.ok) {
                            const data = await contentsRes.json();
                            // Phân loại thư mục và file để nhìn giống cấu trúc thật
                            const dirs = data.filter(item => item.type === 'dir').map(item => '📁 ' + item.name + '/');
                            const files = data.filter(item => item.type === 'file').map(item => '📄 ' + item.name);
                            repoStructure = [...dirs, ...files].join('\n');
                        }
                    } catch (e) { console.warn("Lỗi lấy cấu trúc thư mục", e); }

                    // 2. Fetch README.md
                    try {
                        const readmeRes = await fetch(`https://api.github.com/repos/${extractedPath}/readme`, {
                            headers: { "Accept": "application/vnd.github.v3.raw" }
                        });
                        if (readmeRes.ok) {
                            readmeContent = await readmeRes.text();
                        }
                    } catch (e) { console.warn("Lỗi lấy file README", e); }
                    
                    // 3. Ghép vào Prompt
                    if (repoStructure || readmeContent) {
                        finalPrompt += `\n\n--- THÔNG TIN QUAN TRỌNG CHỐNG ẢO GIÁC ---\n`;
                        finalPrompt += `Dưới đây là cấu trúc thư mục gốc và nội dung file README.md thực tế của dự án. Hãy phân tích dựa CHÍNH XÁC vào dữ liệu này, tuyệt đối không được tự bịa ra công nghệ hay cấu trúc:\n\n`;
                        
                        if (repoStructure) {
                            finalPrompt += `[CẤU TRÚC THƯ MỤC GỐC CỦA DỰ ÁN]:\n${repoStructure}\n\n`;
                        }
                        if (readmeContent) {
                            finalPrompt += `[NỘI DUNG README.md]:\n${readmeContent.substring(0, 30000)}`;
                        }
                        
                        // Cập nhật RepoPath để lát hiện nút File Explorer
                        currentGithubRepoPath = extractedPath;
                    } else {
                        console.warn("Repo không có dữ liệu để chống ảo giác hoặc là Repo Private.");
                    }
                } catch (e) {
                    console.error("Lỗi khi fetch Github Data:", e);
                }
            }
            // =========================================================

            if (currentRepoIndex !== "" && activeTemplateType !== 'explain') {
                finalPrompt = `[NGỮ CẢNH DỰ ÁN TỪ PAGE INDEX ĐÃ LƯU]:\n${currentRepoIndex}\n\n`;
                if (sessionHistory.length > 0) finalPrompt += `[BƯỚC BẠN VỪA HƯỚNG DẪN Ở TRƯỚC ĐÓ]:\n${sessionHistory[sessionHistory.length - 1].response}\n\n`;
                finalPrompt += `---\n[YÊU CẦU MỚI CỦA TÔI]:\n${promptText}`;
            }

            try {
                updateStatus('text-blue-600', "Đang chờ AI phản hồi...");
                const result = await model.generateContent(finalPrompt);
                const text = result.response.text();

                if (activeTemplateType === 'tutor') {
                    const prereqMatch = text.match(/===PREREQ_START===([\s\S]*?)===PREREQ_END===/);
                    if (prereqMatch) {
                        tutorPrerequisites = prereqMatch[1].trim();
                    } else {
                        tutorPrerequisites = "Không có yêu cầu đặc biệt nào được AI gợi ý.";
                    }

                    const parsedSteps = parseTutorSteps(text);
                    if (parsedSteps.length > 0) {
                        tutorSteps = parsedSteps; currentTutorStepIndex = 0;
                        sessionHistory.push({ prompt: "Yêu cầu AI lập giáo án hướng dẫn từng bước...", response: `✅ **Đã tạo thành công lộ trình gồm ${tutorSteps.length} bước.**\n\nHệ thống đã mở cửa sổ Gia sư chuyên dụng để hướng dẫn bạn thực hành.` });
                        
                        openTutorModal(true);
                        
                        btnResumeTutor.classList.remove('hidden');
                        btnResumeTutor.classList.add('flex');
                        
                        loadingIndicator.classList.add('hidden'); renderChatHistory(true); autoSaveRepo(); updateStatus('text-green-600', "Đã tạo giáo án thực hành.");
                        activeTemplateType = "custom"; quickActions.classList.remove('hidden');
                        buttonText.textContent = 'Gửi tới Gemini'; buttonSpinner.classList.add('hidden'); sendPromptButton.disabled = false;
                        return; 
                    }
                }

                if (activeTemplateType === 'explain') {
                    currentRepoIndex = text;
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                    
                    if (currentGithubRepoPath) { 
                        btnOpenExplorer.classList.remove('hidden');
                        btnOpenExplorer.classList.add('flex');
                        document.getElementById('repoContextSubtext').innerText = currentGithubRepoPath;
                    }
                }

                sessionHistory.push({ prompt: promptText, response: text });
                promptInput.value = "";
                loadingIndicator.classList.add('hidden');
                
                renderChatHistory(true);
                autoSaveRepo();
                
                updateStatus('text-green-600', activeTemplateType === 'explain' ? "📌 Đã tự động lưu dự án!" : "Đã lưu tiến trình.");
                activeTemplateType = "custom"; quickActions.classList.remove('hidden');

            } catch (error) {
                loadingIndicator.classList.add('hidden'); updateStatus('text-red-600', `Lỗi: ${error.message}.`); alert("Lỗi gọi API: " + error.message);
            } finally {
                buttonText.textContent = 'Gửi tới Gemini'; buttonSpinner.classList.add('hidden'); sendPromptButton.disabled = false;
            }
        }

        if (sendPromptButton) sendPromptButton.addEventListener("click", callGeminiAPI);
    </script>
</body>
</html>
