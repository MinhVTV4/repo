<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Gia Sư Lập Trình AI - Material Design 3</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Roboto"', 'sans-serif'],
                        display: ['"Google Sans"', 'sans-serif'],
                    },
                    colors: {
                        primary: "#1a73e8", 
                        "primary-hover": "#1557b0",
                        "background-light": "#f8f9fa",
                        "surface-light": "#ffffff",
                    }
                },
            },
        };
    </script>

    <!-- Thư viện Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">

    <!-- CSS bổ sung cho Scrollbar, Animation và Override Markdown -->
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #bdc1c6; }
        
        .markdown-body { background: transparent !important; font-family: inherit !important; }
        
        /* Tinh chỉnh lại hiển thị của Inline Code và Code Block tránh lỗi nền đen chữ đen */
        .markdown-body p code, .markdown-body li code, .markdown-body a code {
            background-color: #f1f5f9 !important;
            color: #e11d48 !important; /* Màu đỏ đô nổi bật trên nền sáng */
            padding: 0.2rem 0.4rem !important;
            border-radius: 0.375rem !important;
            font-size: 0.875em !important;
        }
        .markdown-body pre { background-color: transparent !important; padding: 0 !important; }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%;
            width: 18px; height: 18px; animation: spin 1s linear infinite;
        }
        .large-spinner {
            width: 32px; height: 32px; border-width: 3px; border-color: rgba(26, 115, 232, 0.2);
            border-left-color: #1a73e8; margin: 0;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Custom Modal Transition */
        .custom-modal-overlay {
            opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s;
        }
        .custom-modal-overlay.show { opacity: 1; visibility: visible; }
        .custom-modal { transform: translateY(-20px); transition: transform 0.2s; }
        .custom-modal-overlay.show .custom-modal { transform: translateY(0); }
        
        /* Sidebar transition cho Mobile */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (max-width: 768px) {
            #sidebar { position: fixed; transform: translateX(-100%); z-index: 50; }
            #sidebar.open { transform: translateX(0); }
        }

        /* Nút Cuộn Lên Đầu Trang */
        .show-scroll-btn {
            opacity: 1 !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
        }
    </style>
</head>
<body class="bg-background-light text-gray-800 font-sans h-screen flex overflow-hidden selection:bg-primary selection:text-white relative">

    <!-- Sidebar Overlay (Mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-gray-900/50 z-40 hidden opacity-0 transition-opacity"></div>

    <!-- CỘT TRÁI (SIDEBAR) -->
    <aside id="sidebar" class="w-80 md:w-96 flex flex-col border-r border-gray-200 bg-surface-light shadow-sm h-full flex-shrink-0">
        <div class="p-5 pb-2 border-b border-transparent">
            <h1 class="font-display text-2xl font-medium text-primary flex items-center gap-2">
                <span class="material-symbols-rounded text-3xl">school</span> Gia Sư Lập Trình AI
            </h1>
            <div class="flex items-center gap-2 mt-2 px-1">
                <span class="material-symbols-rounded text-sm text-green-600">bolt</span>
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Mô hình: gemini-2.5-flash</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 py-4 space-y-6">
            <!-- Khung Mẫu -->
            <section>
                <div class="flex items-center justify-between mb-3 px-1">
                    <h2 class="text-sm font-medium text-gray-600">Khung mẫu (Templates)</h2>
                    <span class="material-symbols-rounded text-gray-400 text-lg cursor-pointer hover:text-primary">info</span>
                </div>
                <div class="space-y-2">
                    <button onclick="setTemplate('explain')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">menu_book</span>
                        <span class="text-sm font-medium text-gray-700">1. Giải thích Repo (Nhập môn)</span>
                    </button>
                    <button onclick="setTemplate('tutor')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">steps</span>
                        <span class="text-sm font-medium text-gray-700">2. Dạy từng bước (Thực hành)</span>
                    </button>
                    <button onclick="setTemplate('debug')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">bug_report</span>
                        <span class="text-sm font-medium text-gray-700">3. Sửa lỗi (Debug Terminal)</span>
                    </button>
                    <button onclick="setTemplate('customize')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">tune</span>
                        <span class="text-sm font-medium text-gray-700">4. Tùy chỉnh Project</span>
                    </button>
                    <button onclick="setTemplate('deploy')" class="w-full text-left group flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-200 transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-rounded text-gray-500 group-hover:text-primary">rocket_launch</span>
                        <span class="text-sm font-medium text-gray-700">5. Hướng dẫn Triển khai</span>
                    </button>
                </div>
            </section>

            <!-- Lời nhắc -->
            <section class="flex flex-col gap-3">
                <label class="text-sm font-medium text-gray-600 px-1">Lời nhắc (Prompt)</label>
                
                <!-- Badge ghi nhớ ngữ cảnh -->
                <div id="repoContextBadge" class="hidden bg-green-50 border border-green-200 p-3 rounded-xl flex items-start gap-3 shadow-sm">
                    <span class="material-symbols-rounded text-green-600 text-lg flex-shrink-0 mt-0.5">push_pin</span>
                    <div class="flex-1">
                        <p class="text-xs text-green-800 font-medium">Đã ghi nhớ dự án.</p>
                        <p class="text-[11px] text-green-600">Sẵn sàng dạy từng bước.</p>
                    </div>
                    <button onclick="clearRepoIndex()" class="text-green-500 hover:text-green-700 transition-colors" title="Xóa ghi nhớ">
                        <span class="material-symbols-rounded text-lg">close</span>
                    </button>
                </div>

                <div class="relative">
                    <textarea id="promptInput" class="w-full h-32 p-3 rounded-xl border border-gray-300 bg-white text-sm text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none shadow-sm transition-all" placeholder="Nhập vào các mẫu bên trên hoặc tự dán link GitHub / nhập câu hỏi của bạn vào đây..."></textarea>
                </div>
                
                <button id="sendPromptButton" class="w-full bg-primary hover:bg-primary-hover disabled:bg-blue-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded text-xl">sparkles</span>
                    <span id="buttonText">Gửi tới Gemini</span>
                    <div id="buttonSpinner" class="spinner hidden"></div>
                </button>
                
                <!-- Status Message -->
                <p id="statusMessage" class="text-xs text-center font-medium mt-1 px-2 transition-colors"></p>
            </section>

            <!-- Lịch sử (Các dự án đã học) -->
            <section>
                <div class="flex items-center justify-between mb-3 px-1 mt-2 border-t border-gray-100 pt-4">
                    <h2 class="text-sm font-medium text-gray-600">Các dự án đã học</h2>
                </div>
                <div id="historyList" class="space-y-2">
                    <!-- Sẽ được đổ data từ JS -->
                    <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <span class="material-symbols-rounded text-gray-300 text-3xl mb-2">folder_off</span>
                        <p class="text-xs text-gray-400">Chưa có dự án nào được học.</p>
                    </div>
                </div>
            </section>
        </div>
        
        <div class="p-4 border-t border-gray-200 text-xs text-center text-gray-400">
            © 2026 AI Tutor Platform
        </div>
    </aside>

    <!-- CỘT PHẢI (MAIN CONTENT) -->
    <main class="flex-1 flex flex-col relative bg-white">
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-4 md:px-6 border-b border-gray-100 bg-white z-10 flex-shrink-0">
            <div class="flex items-center gap-4">
                <button id="menuToggle" class="md:hidden p-2 -ml-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <span class="text-sm font-medium text-gray-600">Phiên làm việc</span>
            </div>
            
            <!-- Vùng hiển thị Auth -->
            <div class="flex items-center gap-2">
                <div id="userInfoDisplay" class="hidden flex items-center gap-3">
                    <span id="userEmail" class="text-sm text-gray-600 hidden sm:block max-w-[150px] truncate"></span>
                    <button onclick="logoutUser()" class="text-xs font-medium text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-full transition-colors border border-red-100">Đăng xuất</button>
                </div>
                <div id="userAvatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 text-white flex items-center justify-center text-xs font-bold shadow-sm cursor-pointer hidden">
                    U
                </div>
            </div>
        </header>

        <!-- Body -->
        <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            <div class="max-w-4xl mx-auto w-full flex flex-col h-full">
                
                <!-- Trạng thái trống (Empty State) -->
                <div id="emptyStateContainer" class="flex-1 flex flex-col items-center justify-center text-center animate-fade-in py-10">
                    <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-8 shadow-sm">
                        <span class="material-symbols-rounded text-primary text-5xl">smart_toy</span>
                    </div>
                    <h2 class="font-display text-3xl md:text-4xl text-gray-800 mb-4 font-normal">
                        Xin chào!
                    </h2>
                    <p class="max-w-xl text-lg text-gray-500 leading-relaxed font-light">
                        Hãy dán một đường dẫn GitHub hoặc nhập lời nhắc ở cột bên trái để bắt đầu buổi học. Tôi sẵn sàng hỗ trợ bạn lập trình.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-12 max-w-2xl w-full">
                        <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md transition-all text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="material-symbols-rounded text-orange-500 bg-orange-100 p-1.5 rounded-lg">code</span>
                                <h3 class="font-medium text-gray-700">Phân tích mã nguồn</h3>
                            </div>
                            <p class="text-sm text-gray-500">Hiểu rõ cấu trúc và logic của repo GitHub.</p>
                        </div>
                        <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md transition-all text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="material-symbols-rounded text-purple-500 bg-purple-100 p-1.5 rounded-lg">bug_report</span>
                                <h3 class="font-medium text-gray-700">Gỡ lỗi thông minh</h3>
                            </div>
                            <p class="text-sm text-gray-500">Tìm và sửa lỗi nhanh chóng với giải thích chi tiết.</p>
                        </div>
                    </div>
                </div>

                <!-- Lịch sử Chat -->
                <div id="chatHistoryContainer" class="flex-1"></div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="hidden flex items-center gap-3 text-gray-500 py-6 mb-4">
                    <div class="large-spinner spinner"></div>
                    <span class="text-sm font-medium animate-pulse">Đang phân tích dữ liệu...</span>
                </div>

                <!-- Thao tác nhanh -->
                <div id="quickActions" class="hidden mt-6 pt-6 border-t border-gray-100 flex flex-wrap gap-3 pb-8">
                    <button id="btnNextStep" class="flex items-center gap-2 px-5 py-2.5 bg-blue-50 text-primary hover:bg-blue-100 hover:text-blue-700 rounded-full font-medium text-sm transition-all border border-blue-100">
                        <span>Tiếp tục bước tiếp theo</span>
                        <span class="material-symbols-rounded text-lg">arrow_forward</span>
                    </button>
                    <button id="btnGotBug" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 rounded-full font-medium text-sm transition-all shadow-sm">
                        <span>Tôi gặp lỗi ở bước này</span>
                        <span class="material-symbols-rounded text-lg text-orange-500">bug_report</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Nút Cuộn lên đầu trang (Nằm trong thẻ Main để fixed theo viewport) -->
        <button id="scrollToTopBtn" class="fixed bottom-6 right-6 w-12 h-12 bg-primary text-white rounded-full shadow-xl flex items-center justify-center z-50 hover:bg-primary-hover hover:-translate-y-1 transition-all opacity-0 translate-y-4 pointer-events-none" title="Cuộn lên đầu trang">
            <span class="material-symbols-rounded">arrow_upward</span>
        </button>
    </main>

    <!-- MODALS -->
    <!-- Modal Xác nhận (Confirm) -->
    <div id="confirmModal" class="custom-modal-overlay fixed inset-0 bg-gray-900/40 z-[999] flex items-center justify-center backdrop-blur-sm">
        <div class="custom-modal bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <h3 class="font-display text-lg font-medium text-gray-800 mb-2">Xác nhận</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6 text-sm">Bạn có chắc chắn?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('confirmModal')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">Hủy</button>
                <button id="confirmYesBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-xl transition-colors shadow-sm">Đồng ý xóa</button>
            </div>
        </div>
    </div>

    <!-- Modal Nhập liệu (Prompt) -->
    <div id="promptModal" class="custom-modal-overlay fixed inset-0 bg-gray-900/40 z-[999] flex items-center justify-center backdrop-blur-sm">
        <div class="custom-modal bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <h3 id="promptTitle" class="font-display text-lg font-medium text-gray-800 mb-4">Nhập thông tin</h3>
            <input type="text" id="promptInputVal" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm text-gray-800 mb-6" autocomplete="off">
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('promptModal')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">Hủy</button>
                <button id="promptYesBtn" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors shadow-sm">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Modal Auth (Đăng nhập) -->
    <div id="authModal" class="custom-modal-overlay show fixed inset-0 bg-gray-900/60 z-[1000] flex items-center justify-center backdrop-blur-md">
        <div class="custom-modal bg-white rounded-3xl p-8 w-[90%] max-w-md shadow-2xl border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary">
                    <span class="material-symbols-rounded text-3xl">cloud_sync</span>
                </div>
                <h3 class="font-display text-2xl font-medium text-gray-800 mb-2">Đồng bộ Đám mây</h3>
                <p class="text-gray-500 text-sm">Đăng nhập để tự động lưu và đồng bộ lịch sử học tập của bạn qua Firestore.</p>
            </div>
            
            <div id="authError" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-xl mb-4 border border-red-100 font-medium text-center"></div>
            
            <div class="space-y-4 mb-8">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1 ml-1">Email</label>
                    <input type="email" id="authEmail" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm" placeholder="user@email.com">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1 ml-1">Mật khẩu</label>
                    <input type="password" id="authPassword" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm" placeholder="Ít nhất 6 ký tự">
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="registerUser()" class="flex-1 py-3 text-sm font-medium text-primary bg-blue-50 hover:bg-blue-100 rounded-xl transition-colors border border-blue-100">Tạo tài khoản</button>
                <button onclick="loginUser()" class="flex-1 py-3 text-sm font-medium text-white bg-primary hover:bg-primary-hover rounded-xl transition-colors shadow-md hover:shadow-lg">Đăng nhập</button>
            </div>
        </div>
    </div>

    <!-- LOGIC JS (Giữ nguyên 100% Core Logic cũ) -->
    <script type="module">
        // Polyfill cho AbortSignal.any
        if (typeof AbortSignal !== 'undefined' && !AbortSignal.any) {
            AbortSignal.any = function(signals) {
                const controller = new AbortController();
                for (const signal of signals) {
                    if (signal.aborted) {
                        controller.abort(signal.reason);
                        return controller.signal;
                    }
                    signal.addEventListener('abort', () => controller.abort(signal.reason), { once: true });
                }
                return controller.signal;
            };
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-ai.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAtoX3PysX692bNg6nA55Qriv5P-7phmFQ",
          authDomain: "aiminh-d96d4.firebaseapp.com",
          projectId: "aiminh-d96d4",
          storageBucket: "aiminh-d96d4.firebasestorage.app",
          messagingSenderId: "159603803322",
          appId: "1:159603803322:web:3693589412fca5c3456e83"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const statusMessage = document.getElementById('statusMessage');

        // Biến hệ thống
        let currentRepoId = null; 
        let sessionHistory = []; 
        let currentRepoIndex = ""; 
        let activeTemplateType = "custom"; 

        const emptyStateContainer = document.getElementById('emptyStateContainer');
        const chatHistoryContainer = document.getElementById('chatHistoryContainer');
        const historyList = document.getElementById('historyList');
        const quickActions = document.getElementById('quickActions');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // --- SCROLL TO TOP LOGIC ---
        const mainContentElement = document.getElementById('main-content');
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');

        mainContentElement.addEventListener('scroll', () => {
            if (mainContentElement.scrollTop > 300) {
                scrollToTopBtn.classList.add('show-scroll-btn');
            } else {
                scrollToTopBtn.classList.remove('show-scroll-btn');
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            mainContentElement.scrollTo({ top: 0, behavior: 'smooth' });
        });

        window.clearRepoIndex = function() {
            currentRepoId = null;
            currentRepoIndex = "";
            sessionHistory = [];
            document.getElementById('repoContextBadge').classList.add('hidden');
            quickActions.classList.add('hidden');
            chatHistoryContainer.innerHTML = '';
            emptyStateContainer.classList.remove('hidden'); // Hiện lại màn hình chào
            updateStatus('text-blue-600', "Đã tạo phiên học mới.");
        };

        // --- LOGIC AUTH ---
        const authModal = document.getElementById('authModal');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authError = document.getElementById('authError');
        const userInfoDisplay = document.getElementById('userInfoDisplay');
        const userEmailSpan = document.getElementById('userEmail');
        const userAvatar = document.getElementById('userAvatar');

        function showAuthError(msg) {
            authError.textContent = msg;
            authError.classList.remove('hidden');
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authModal.classList.remove('show');
                userInfoDisplay.classList.remove('hidden');
                userAvatar.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                userAvatar.textContent = user.email.charAt(0).toUpperCase();
                updateStatus('text-blue-600', "Đã kết nối đám mây. Đang tải dữ liệu...");
                loadHistory(); 
            } else {
                authModal.classList.add('show');
                userInfoDisplay.classList.add('hidden');
                userAvatar.classList.add('hidden');
                historyList.innerHTML = `
                    <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <span class="material-symbols-rounded text-gray-300 text-3xl mb-2">lock</span>
                        <p class="text-xs text-gray-400">Vui lòng đăng nhập để xem.</p>
                    </div>`;
                clearRepoIndex(); 
            }
        });

        window.loginUser = async function() {
            try {
                showAuthError("Đang đăng nhập...");
                authError.classList.replace('bg-red-50', 'bg-blue-50');
                authError.classList.replace('text-red-600', 'text-blue-600');
                await signInWithEmailAndPassword(auth, authEmail.value, authPassword.value);
            } catch (error) {
                authError.classList.replace('bg-blue-50', 'bg-red-50');
                authError.classList.replace('text-blue-600', 'text-red-600');
                showAuthError("Lỗi đăng nhập: " + error.message);
            }
        };

        window.registerUser = async function() {
            try {
                showAuthError("Đang tạo tài khoản...");
                authError.classList.replace('bg-red-50', 'bg-blue-50');
                authError.classList.replace('text-red-600', 'text-blue-600');
                await createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value);
            } catch (error) {
                authError.classList.replace('bg-blue-50', 'bg-red-50');
                authError.classList.replace('text-blue-600', 'text-red-600');
                showAuthError("Lỗi đăng ký: " + error.message);
            }
        };

        window.logoutUser = async function() {
            await signOut(auth);
        };

        // --- LOGIC CUSTOM MODAL ---
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showCustomConfirm(message, onConfirm) {
            document.getElementById('confirmMessage').innerText = message;
            const overlay = document.getElementById('confirmModal');
            const yesBtn = document.getElementById('confirmYesBtn');
            overlay.classList.add('show');
            yesBtn.onclick = function() { closeModal('confirmModal'); onConfirm(); };
        }

        function showCustomPrompt(title, defaultVal, onConfirm) {
            document.getElementById('promptTitle').innerText = title;
            const inputField = document.getElementById('promptInputVal');
            const overlay = document.getElementById('promptModal');
            const yesBtn = document.getElementById('promptYesBtn');
            inputField.value = defaultVal;
            overlay.classList.add('show');
            inputField.focus();
            yesBtn.onclick = function() { closeModal('promptModal'); onConfirm(inputField.value); };
            inputField.onkeydown = function(e) { if (e.key === 'Enter') yesBtn.click(); }
        }

        // --- LOGIC LƯU TRỮ FIRESTORE ---
        let currentUserRepos = [];

        async function loadHistory() {
            if (!auth.currentUser) return;
            const q = query(collection(db, `users/${auth.currentUser.uid}/repos`), orderBy("updatedAt", "desc"));
            try {
                const querySnapshot = await getDocs(q);
                currentUserRepos = [];
                historyList.innerHTML = "";
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = `
                        <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                            <span class="material-symbols-rounded text-gray-300 text-3xl mb-2">folder_off</span>
                            <p class="text-xs text-gray-400">Chưa có dự án nào.</p>
                        </div>`;
                    return;
                }
                
                querySnapshot.forEach(docSnap => {
                    const repo = { id: docSnap.id, ...docSnap.data() };
                    currentUserRepos.push(repo);
                    
                    const dateStr = new Date(repo.updatedAt).toLocaleString('vi-VN', {hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
                    const item = document.createElement('div');
                    item.className = 'group flex items-center justify-between p-3 rounded-xl border border-transparent bg-gray-50 hover:bg-blue-50 hover:border-blue-100 cursor-pointer transition-all mb-2';
                    item.innerHTML = `
                        <div style="overflow: hidden; flex-grow: 1;" onclick="viewRepo('${repo.id}')">
                            <div class="text-sm font-medium text-gray-700 truncate">${repo.title}</div>
                            <div class="text-[11px] text-gray-500 mt-0.5">${repo.history.length} mục • ${dateStr}</div>
                        </div>
                        <button class="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" onclick="deleteRepo('${repo.id}', event)" title="Xóa">
                            <span class="material-symbols-rounded text-[18px]">delete</span>
                        </button>
                    `;
                    historyList.appendChild(item);
                });
            } catch (error) {
                console.error("Lỗi tải Firestore:", error);
                updateStatus('text-red-600', "Lỗi tải dữ liệu. Kiểm tra Rules.");
            }
        }

        window.viewRepo = function(id) {
            const repo = currentUserRepos.find(r => r.id === id);
            if(repo) {
                currentRepoId = repo.id;
                currentRepoIndex = repo.repoIndex || "";
                sessionHistory = repo.history || [];
                
                renderChatHistory(); 
                
                if (currentRepoIndex !== "") {
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }
                quickActions.classList.remove('hidden');
                updateStatus('text-blue-600', `Đang học dự án: ${repo.title}`);
                
                if(window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('open')) {
                    toggleSidebar();
                }
            }
        };

        window.deleteRepo = function(id, event) {
            event.stopPropagation();
            showCustomConfirm("Xóa toàn bộ tiến trình học của dự án này trên đám mây?", async () => {
                try {
                    await deleteDoc(doc(db, `users/${auth.currentUser.uid}/repos`, id));
                    if (currentRepoId === id) clearRepoIndex(); 
                    loadHistory();
                    updateStatus('text-green-600', "Đã xóa dự án trên đám mây.");
                } catch (error) {
                    alert("Lỗi khi xóa: " + error.message);
                }
            });
        };

        // Hàm trích xuất tên thông minh từ câu lệnh người dùng
        function extractDefaultTitle(promptText) {
            // 1. Ưu tiên tìm link GitHub (vd: github.com/user/repo)
            const githubRegex = /github\.com\/([^/\s]+\/[^/\s]+)/i;
            const match = promptText.match(githubRegex);
            if (match && match[1]) {
                let repoName = match[1].replace('.git', '');
                return "Repo: " + repoName;
            }
            
            // 2. Nếu không có link, lấy dòng mã nguồn/thông tin cuối cùng người dùng dán vào
            const lines = promptText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const lastLine = lines[lines.length - 1];
            
            // Bỏ qua các câu lệnh của Template để lấy nội dung thực tế
            if (lastLine && !lastLine.includes("DÁN LINK") && !lastLine.includes("Hãy đóng vai")) {
                return "Dự án: " + (lastLine.length > 25 ? lastLine.substring(0, 25) + "..." : lastLine);
            }
            
            return "Dự án Lập trình mới";
        }

        async function autoSaveRepo() {
            if (!auth.currentUser || sessionHistory.length === 0) return;
            const reposRef = collection(db, `users/${auth.currentUser.uid}/repos`);

            if (currentRepoId === null) {
                // Sử dụng hàm trích xuất thông minh thay vì cắt chuỗi bừa bãi
                let defaultTitle = extractDefaultTitle(sessionHistory[0].prompt);
                
                showCustomPrompt("Đặt tên dự án để lưu lên đám mây:", defaultTitle, async (title) => {
                    if (title.trim() === "") title = defaultTitle;
                    const newRepoRef = doc(reposRef);
                    currentRepoId = newRepoRef.id; 
                    await setDoc(newRepoRef, {
                        title: title, repoIndex: currentRepoIndex, history: sessionHistory, updatedAt: new Date().getTime()
                    });
                    loadHistory();
                });
            } else {
                const repoRef = doc(db, `users/${auth.currentUser.uid}/repos`, currentRepoId);
                await setDoc(repoRef, {
                    repoIndex: currentRepoIndex, history: sessionHistory, updatedAt: new Date().getTime()
                }, { merge: true }); 
                loadHistory();
            }
        }

        // --- RENDER GIAO DIỆN CHAT VÀ AUTO SCROLL ---
        function renderChatHistory(isNewMessage = false) {
            emptyStateContainer.classList.add('hidden'); // Ẩn màn hình chào
            chatHistoryContainer.innerHTML = "";
            
            sessionHistory.forEach(item => {
                const block = document.createElement('div');
                block.className = 'mb-8 pb-6 border-b border-gray-100 last:border-0 chat-block';
                block.innerHTML = `
                    <div class="bg-blue-50/50 p-4 rounded-2xl rounded-tr-sm border border-blue-100/50 text-gray-800 font-medium mb-5 text-[15px] whitespace-pre-wrap flex gap-3 shadow-sm">
                        <span class="material-symbols-rounded text-primary flex-shrink-0 mt-0.5">person</span>
                        <div class="leading-relaxed">${item.prompt}</div>
                    </div>
                    <div class="markdown-body !text-[15px] leading-relaxed text-gray-800">
                        ${marked.parse(item.response)}
                    </div>
                `;
                chatHistoryContainer.appendChild(block);
            });

            // Logic tự động cuộn
            if (isNewMessage) {
                // Cuộn chính xác lên mép đầu của câu trả lời vừa xuất hiện
                const lastBlock = chatHistoryContainer.lastElementChild;
                if (lastBlock) {
                    setTimeout(() => {
                        lastBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 50); // Chờ DOM render xong
                }
            } else {
                // Khi load bài cũ từ sidebar thì cuộn thẳng xuống đáy màn hình
                mainContentElement.scrollTop = mainContentElement.scrollHeight;
            }
        }

        // --- QUICK ACTIONS ---
        document.getElementById('btnNextStep').addEventListener('click', () => {
            promptInput.value = "Tôi đã hoàn thành bước vừa rồi. Hãy tiếp tục hướng dẫn tôi bước tiếp theo.";
            sendPromptButton.click();
        });

        document.getElementById('btnGotBug').addEventListener('click', () => {
            promptInput.value = "Tôi gặp lỗi ở bước này. Lý do có thể là gì và làm sao để kiểm tra/khắc phục? Đây là mã lỗi tôi thấy:\n[DÁN MÃ LỖI VÀO ĐÂY]";
            promptInput.focus();
            if(window.innerWidth <= 768 && !document.getElementById('sidebar').classList.contains('open')) {
                toggleSidebar();
            }
        });

        // --- CHỨC NĂNG COPY CODE ---
        // Lắng nghe sự kiện click trên toàn document để bắt nút "Sao chép"
        document.addEventListener('click', function(e) {
            const copyBtn = e.target.closest('.copy-btn');
            if (!copyBtn) return;

            const codeToCopy = decodeURIComponent(copyBtn.getAttribute('data-code'));
            
            // Xử lý logic copy bằng textarea (tương thích cả iFrame)
            const textArea = document.createElement("textarea");
            textArea.value = codeToCopy;
            // Tránh scroll màn hình khi chèn textarea
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const icon = copyBtn.querySelector('.material-symbols-rounded');
                    const text = copyBtn.querySelector('.copy-text');
                    
                    const originalIcon = icon.innerText;
                    const originalText = text.innerText;
                    
                    // Hiển thị trạng thái thành công
                    icon.innerText = 'check';
                    icon.classList.add('text-green-500');
                    text.innerText = 'Đã chép!';
                    text.classList.add('text-green-500');
                    
                    // Reset lại sau 2 giây
                    setTimeout(() => {
                        icon.innerText = originalIcon;
                        icon.classList.remove('text-green-500');
                        text.innerText = originalText;
                        text.classList.remove('text-green-500');
                    }, 2000);
                }
            } catch (err) {
                console.error('Lỗi khi copy', err);
            }
            document.body.removeChild(textArea);
        });

        // --- SIDEBAR MOBILE ---
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            if(sidebar.classList.contains('open')) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('opacity-100'), 10);
            } else {
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }
        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        // --- HELPERS & AI ---
        function updateStatus(colorClass, message) {
            statusMessage.className = `text-xs text-center font-medium mt-1 px-2 transition-colors ${colorClass}`;
            statusMessage.innerHTML = message; 
        }

        updateStatus('text-blue-600', "Firebase App khởi tạo.<br>Đang chờ mô hình AI...");

        // Ghi đè bộ cấu hình Render của Marked.js để tạo ra Giao diện Code Block mới cực đẹp
        const renderer = new marked.Renderer();
        renderer.code = function(codeOrToken, language) {
            let code = codeOrToken;
            let lang = language;
            
            // Xử lý tương thích cho các phiên bản Marked.js khác nhau
            if (typeof codeOrToken === 'object') {
                code = codeOrToken.text;
                lang = codeOrToken.lang;
            }
            
            const validLang = (lang && hljs.getLanguage(lang)) ? lang : 'plaintext';
            const highlighted = validLang === 'plaintext' ? hljs.highlightAuto(code).value : hljs.highlight(code, { language: validLang }).value;
            const encodedCode = encodeURIComponent(code); // Mã hóa code an toàn để gán vào nút

            return `
            <div class="code-block-wrapper rounded-xl overflow-hidden bg-[#0d1117] border border-gray-700 my-5 shadow-md">
                <div class="flex items-center justify-between px-4 py-2.5 bg-[#161b22] border-b border-gray-700">
                    <span class="text-[11px] font-medium text-gray-400 uppercase tracking-wider">${validLang}</span>
                    <button class="copy-btn flex items-center gap-1.5 text-[12px] text-gray-400 hover:text-white transition-colors focus:outline-none" data-code="${encodedCode}">
                        <span class="material-symbols-rounded text-[16px]">content_copy</span> 
                        <span class="copy-text">Sao chép</span>
                    </button>
                </div>
                <div class="p-4 overflow-x-auto text-[14px]">
                    <pre class="!m-0 !bg-transparent !p-0"><code class="hljs language-${validLang} !text-[#e6edf3] !bg-transparent">${highlighted}</code></pre>
                </div>
            </div>`;
        };

        // Kích hoạt custom renderer
        marked.use({ renderer });

        const systemPrompt = `You are an AI Technical Tutor.

Your task is to turn any GitHub repository into a complete, beginner-friendly tutorial.

Assume the user is a beginner developer.
Never skip steps.
Never assume prior knowledge.

For every repository, always follow this structure:
1. Explain what problem this repository solves.
2. Explain the big picture architecture.
3. Show the file structure and which file to start with.
4. Explain the execution flow from input to output.
5. Give step-by-step terminal commands to run locally.
6. Explain each command and what it does.
7. Explain how to modify or extend the project.
8. Explain how to deploy (if applicable).

Rules:
- Use simple language.
- Explain before showing code.
- When showing code, explain what each part does.
- Never say "just run this".
- Teach like a real instructor, not like a chatbot.`;

        let model;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash", systemInstruction: systemPrompt });
            updateStatus('text-green-600', "AI Tutor đã sẵn sàng.");
        } catch (e) {
            updateStatus('text-red-600', `Lỗi AI: ${e.message}`);
        }

        const templates = {
            explain: "Hãy đóng vai một chuyên gia lập trình. Đọc repository dưới đây và tạo ra một bản tóm tắt kiến trúc dự án, luồng hoạt động chính và các file quan trọng. Giải thích cho tôi hiểu như một người mới bắt đầu.\n\n[DÁN LINK GITHUB HOẶC MÃ NGUỒN VÀO ĐÂY]",
            tutor: "Bây giờ hãy dạy tôi thực hành dự án trên từng bước một.\nSau mỗi bước, hãy đợi tôi xác nhận trước khi tiếp tục.\nNếu tôi gặp lỗi, hãy giúp tôi sửa (debug).",
            debug: "Tôi nhận được thông báo lỗi này trong quá trình làm. Hãy giải thích bằng ngôn ngữ đơn giản tại sao lại bị lỗi và cách khắc phục.\n[DÁN LOG LỖI VÀO ĐÂY]",
            customize: "Tôi muốn tùy chỉnh dự án này cho mục đích cá nhân của mình:\n[ĐIỀN MỤC TIÊU CỦA BẠN VÀO ĐÂY]\n\nHãy giải thích những gì tôi cần thay đổi trong mã nguồn.",
            deploy: "Hãy hướng dẫn tôi cách triển khai (deploy) dự án này lên mạng.\nCứ giả định rằng tôi chưa từng deploy bất cứ thứ gì trước đây.\nHãy giải thích cặn kẽ từng bước."
        };

        window.setTemplate = function(type) {
            activeTemplateType = type; 
            promptInput.value = templates[type];
            promptInput.focus();
            if(window.innerWidth <= 768 && sidebar.classList.contains('open')) { /* toggleSidebar(); */ }
        };

        async function callGeminiAPI() {
            if (!model) return updateStatus('text-red-600', "Mô hình AI lỗi.");
            const promptText = promptInput.value.trim();
            if (!promptText) return updateStatus('text-red-600', "Vui lòng nhập lời nhắc!");

            updateStatus('text-blue-600', "Đang gửi yêu cầu...");
            
            quickActions.classList.add('hidden');
            emptyStateContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            buttonText.textContent = 'Đang xử lý...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            if(window.innerWidth <= 768 && sidebar.classList.contains('open')) toggleSidebar();

            let finalPrompt = promptText;
            if (currentRepoIndex !== "" && activeTemplateType !== 'explain') {
                finalPrompt = `[NGỮ CẢNH DỰ ÁN TỪ PAGE INDEX ĐÃ LƯU]:\n${currentRepoIndex}\n\n`;
                if (sessionHistory.length > 0) {
                    finalPrompt += `[BƯỚC BẠN VỪA HƯỚNG DẪN Ở TRƯỚC ĐÓ]:\n${sessionHistory[sessionHistory.length - 1].response}\n\n`;
                }
                finalPrompt += `---\n[YÊU CẦU MỚI CỦA TÔI]:\n${promptText}`;
            }

            try {
                const result = await model.generateContent(finalPrompt);
                const text = result.response.text();

                if (activeTemplateType === 'explain') {
                    currentRepoIndex = text;
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }

                sessionHistory.push({ prompt: promptText, response: text });
                promptInput.value = "";

                loadingIndicator.classList.add('hidden');
                
                // Gọi render với cờ true để hệ thống tự động scroll đến đầu tin nhắn mới nhất
                renderChatHistory(true);
                
                autoSaveRepo();
                
                updateStatus('text-green-600', activeTemplateType === 'explain' ? "📌 Đã tự động lưu dự án!" : "Đã lưu tiến trình.");
                activeTemplateType = "custom";
                quickActions.classList.remove('hidden');

            } catch (error) {
                loadingIndicator.classList.add('hidden');
                updateStatus('text-red-600', `Lỗi: ${error.message}.`);
                alert("Lỗi gọi API: " + error.message);
            } finally {
                buttonText.textContent = 'Gửi tới Gemini';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
            }
        }

        if (sendPromptButton) sendPromptButton.addEventListener("click", callGeminiAPI);
    </script>
</body>
</html>
