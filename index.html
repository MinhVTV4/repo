<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia S∆∞ L·∫≠p Tr√¨nh AI - Gemini API</title>
    
    <!-- Th∆∞ vi·ªán Marked.js, Highlight.js v√† GitHub Markdown CSS -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">

    <style>
        /* CSS C∆° B·∫£n & Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f6f8fa; /* M√†u n·ªÅn Github */
            color: #24292f; 
            display: flex;
            height: 100vh; /* S√°t l·ªÅ, full m√†n h√¨nh */
            overflow: hidden;
        }

        /* --- C·ªòT TR√ÅI (SIDEBAR / CONTROLS) --- */
        #sidebar {
            width: 360px;
            background-color: #ffffff;
            border-right: 1px solid #d0d7de;
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #eaeeef;
        }
        .sidebar-header h1 { 
            color: #0969da; 
            font-size: 1.25rem;
            margin-bottom: 5px;
        }
        .sidebar-header h2 {
            font-size: 0.85rem;
            color: #57606a;
            font-weight: normal;
        }

        #controls { 
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung d√†i */
            flex-grow: 1;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #24292f;
        }

        .template-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        .template-btn {
            padding: 10px 15px;
            background-color: #f6f8fa;
            color: #24292f;
            border: 1px solid #d0d7de;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-weight: 500;
        }
        .template-btn:hover {
            background-color: #f3f4f6;
            border-color: #0969da;
            color: #0969da;
        }

        textarea { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #d0d7de; 
            border-radius: 6px; 
            resize: vertical;
            font-size: 14px;
            font-family: inherit;
            min-height: 120px;
            background-color: #f6f8fa;
        }
        textarea:focus {
            outline: none;
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9,105,218,0.3);
            background-color: #fff;
        }

        button#sendPromptButton { 
            padding: 12px; 
            background-color: #2da44e; /* M√†u xanh Github action */
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 15px;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        button#sendPromptButton:hover { background-color: #2c974b; }
        button#sendPromptButton:disabled { background-color: #94d3a2; cursor: not-allowed; }

        /* --- L·ªäCH S·ª¨ B√ÄI H·ªåC (INDEXEDDB) --- */
        #historyList {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .history-item {
            padding: 10px;
            background-color: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .history-item:hover {
            background-color: #f3f4f6;
            border-color: #0969da;
        }
        .history-title {
            font-weight: 600;
            color: #24292f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            margin-bottom: 4px;
        }
        .history-date {
            font-size: 11px;
            color: #57606a;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #cf222e;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0.6;
            transition: all 0.2s;
        }
        .delete-btn:hover { background-color: #ffebe9; opacity: 1; }

        .save-btn {
            padding: 8px 16px;
            background-color: #2da44e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }
        .save-btn:hover { background-color: #2c974b; }

        /* --- TR·∫†NG TH√ÅI (STATUS) --- */
        .status-message {
            margin-top: 15px;
            font-size: 0.85rem;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            line-height: 1.4;
        }
        .status-message.error-text { background-color: #ffebe9; color: #cf222e; }
        .status-message.success-text { background-color: #dafbe1; color: #1a7f37; }
        .status-message.info-text { background-color: #ddf4ff; color: #0969da; }

        /* --- C·ªòT PH·∫¢I (MAIN CONTENT) --- */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }
        
        #responseContainer { 
            padding: 40px; 
            background-color: #fff; 
            min-height: 100%; 
            width: 100%;
            max-width: 900px;
            margin: 0 auto; /* CƒÉn gi·ªØa n·ªôi dung vƒÉn b·∫£n */
            box-shadow: 0 0 15px rgba(0,0,0,0.03);
            transition: opacity 0.3s ease;
        }
        #responseContainer.loading {
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #57606a;
        }

        .placeholder-text {
            color: #57606a;
            font-size: 1.1rem;
            text-align: center;
            margin-top: 20%;
        }

        /* --- SPINNER --- */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .large-spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
            border-left-color: #0969da;
            border-color: rgba(9, 105, 218, 0.2);
            border-left-color: #0969da;
            margin-bottom: 15px;
        }
        .hidden { display: none !important; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- CUSTOM MODALS (POPUP) --- */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .custom-modal-overlay.show {
            opacity: 1; visibility: visible;
        }
        .custom-modal {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            width: 90%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: transform 0.2s;
        }
        .custom-modal-overlay.show .custom-modal {
            transform: translateY(0);
        }
        .custom-modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; color: #24292f; }
        .custom-modal-input { width: 100%; padding: 10px; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
        .custom-modal-input:focus { outline: none; border-color: #0969da; }
        .custom-modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; }
        .modal-btn-cancel { background: #f6f8fa; color: #24292f; border: 1px solid #d0d7de; }
        .modal-btn-cancel:hover { background: #eaeeef; }
        .modal-btn-danger { background: #cf222e; color: white; }
        .modal-btn-danger:hover { background: #a40e26; }
        .modal-btn-primary { background: #2da44e; color: white; }
        .modal-btn-primary:hover { background: #2c974b; }

        /* --- QUICK ACTIONS (THAO T√ÅC NHANH) --- */
        #quickActions {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eaeeef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .quick-btn {
            padding: 8px 16px; border-radius: 20px; font-size: 13.5px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s; border: none;
        }
        .quick-btn-next { background-color: #0969da; color: white; }
        .quick-btn-next:hover { background-color: #0550ae; transform: translateX(2px); }
        .quick-btn-bug { background-color: #f6f8fa; color: #24292f; border: 1px solid #d0d7de; }
        .quick-btn-bug:hover { background-color: #eaeeef; }

        /* --- MOBILE RESPONSIVE (SIDEBAR TR∆Ø·ª¢T) --- */
        .mobile-header {
            display: none;
            align-items: center;
            background-color: #24292f;
            color: #fff;
            padding: 12px 20px;
            z-index: 101;
        }
        .mobile-header h1 {
            font-size: 1.1rem;
            margin-left: 15px;
            font-weight: 600;
        }
        .hamburger-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        #sidebarOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s;
        }

        @media (max-width: 850px) {
            body { flex-direction: column; }
            .mobile-header { display: flex; }
            
            #sidebar {
                position: fixed;
                top: 0; bottom: 0; left: 0;
                width: 320px;
                transform: translateX(-100%);
                box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            }
            #sidebar.open { transform: translateX(0); }
            
            #sidebarOverlay.show {
                display: block;
                opacity: 1;
            }

            .sidebar-header { display: none; /* ·∫®n header tr√°i tr√™n mobile do ƒë√£ c√≥ thanh ƒëen tr√™n c√πng */ }
            
            #main-content {
                height: calc(100vh - 53px); /* Tr·ª´ ƒëi height c·ªßa mobile header */
            }
            #responseContainer { padding: 20px; }
            .placeholder-text { margin-top: 30%; font-size: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Header d√†nh ri√™ng cho Mobile -->
    <div class="mobile-header">
        <button class="hamburger-btn" id="menuToggle">‚ò∞</button>
        <h1>Gia S∆∞ L·∫≠p Tr√¨nh AI</h1>
    </div>

    <!-- L·ªõp ph·ªß m√†n m·ªù tr√™n Mobile khi m·ªü Sidebar -->
    <div id="sidebarOverlay"></div>

    <!-- C·ªòT TR√ÅI: Thanh c√¥ng c·ª• -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>Gia S∆∞ L·∫≠p Tr√¨nh AI</h1>
            <h2>M√¥ h√¨nh: gemini-2.5-flash</h2>
        </div>
        
        <div id="controls">
            <div class="section-title">Khung m·∫´u (Templates)</div>
            <div class="template-buttons">
                <button class="template-btn" onclick="setTemplate('explain')">üìñ 1. Gi·∫£i th√≠ch Repo (Nh·∫≠p m√¥n)</button>
                <button class="template-btn" onclick="setTemplate('tutor')">üéì 2. D·∫°y t·ª´ng b∆∞·ªõc (Th·ª±c h√†nh)</button>
                <button class="template-btn" onclick="setTemplate('debug')">üêõ 3. S·ª≠a l·ªói (Debug Terminal)</button>
                <button class="template-btn" onclick="setTemplate('customize')">üõ†Ô∏è 4. T√πy ch·ªânh Project</button>
                <button class="template-btn" onclick="setTemplate('deploy')">üöÄ 5. H∆∞·ªõng d·∫´n Tri·ªÉn khai</button>
            </div>
            
            <div class="section-title">L·ªùi nh·∫Øc (Prompt)</div>
            
            <div id="repoContextBadge" class="hidden" style="font-size: 12px; color: #1a7f37; background-color: #dafbe1; padding: 8px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #a3e4b5; display: flex; justify-content: space-between; align-items: center;">
                <span>üìå ƒê√£ ghi nh·ªõ c·∫•u tr√∫c d·ª± √°n. (S·∫µn s√†ng d·∫°y t·ª´ng b∆∞·ªõc)</span>
                <button onclick="clearRepoIndex()" style="background: none; border: none; color: #cf222e; cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1;" title="X√≥a ghi nh·ªõ">√ó</button>
            </div>
            
            <textarea id="promptInput" placeholder="Nh·∫•p v√†o c√°c m·∫´u b√™n tr√™n ho·∫∑c t·ª± d√°n link GitHub / nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            
            <button id="sendPromptButton">
                <span id="buttonText">G·ª≠i t·ªõi Gemini</span>
                <div id="buttonSpinner" class="spinner hidden"></div>
            </button>
            
            <p id="statusMessage" class="status-message"></p>

            <hr style="border: 0; border-top: 1px solid #d0d7de; margin: 20px 0;">
            
            <div class="section-title">L·ªãch s·ª≠ b√†i h·ªçc</div>
            <div id="historyList">
                <div style="font-size: 13px; color: #57606a;">Ch∆∞a c√≥ b√†i h·ªçc n√†o ƒë∆∞·ª£c l∆∞u.</div>
            </div>
        </div>
    </div>
    
    <!-- C·ªòT PH·∫¢I: Khung hi·ªÉn th·ªã n·ªôi dung -->
    <div id="main-content">
        <div id="responseContainer" class="markdown-body">
            <button id="saveLessonBtn" class="save-btn hidden">üíæ L∆∞u b√†i h·ªçc n√†y</button>
            <div id="responseContent">
                <div class="placeholder-text">
                    Xin ch√†o! <br><br>H√£y d√°n m·ªôt ƒë∆∞·ªùng d·∫´n GitHub ho·∫∑c nh·∫≠p l·ªùi nh·∫Øc ·ªü c·ªôt b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu bu·ªïi h·ªçc.
                </div>
            </div>
            
            <!-- Thanh thao t√°c nhanh (M·∫∑c ƒë·ªãnh ·∫©n) -->
            <div id="quickActions" class="hidden">
                <button id="btnNextStep" class="quick-btn quick-btn-next">Ti·∫øp t·ª•c b∆∞·ªõc ti·∫øp theo ‚û°Ô∏è</button>
                <button id="btnGotBug" class="quick-btn quick-btn-bug">T√¥i g·∫∑p l·ªói ·ªü b∆∞·ªõc n√†y üêõ</button>
            </div>
        </div>
    </div>

    <!-- HTML C√ÅC MODALS -->
    <!-- Modal X√°c nh·∫≠n (Confirm) -->
    <div id="confirmModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="custom-modal-title" id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn?</div>
            <div class="custom-modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('confirmModal')">H·ªßy</button>
                <button class="modal-btn modal-btn-danger" id="confirmYesBtn">X√≥a</button>
            </div>
        </div>
    </div>

    <!-- Modal Nh·∫≠p li·ªáu (Prompt) -->
    <div id="promptModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="custom-modal-title" id="promptTitle">Nh·∫≠p th√¥ng tin</div>
            <input type="text" id="promptInputVal" class="custom-modal-input" autocomplete="off">
            <div class="custom-modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('promptModal')">H·ªßy</button>
                <button class="modal-btn modal-btn-primary" id="promptYesBtn">L∆∞u b√†i</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-ai.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDBeliQXZDzIOyVVfnKdoKi-yTMgt33its",
          authDomain: "test-f9b86.firebaseapp.com",
          projectId: "test-f9b86",
          storageBucket: "test-f9b86.firebasestorage.app",
          messagingSenderId: "853017830675",
          appId: "1:853017830675:web:b56ebdccc9219c596ba6e6"
        };

        const app = initializeApp(firebaseConfig);
        console.log("Firebase App initialized!");
        
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        // --- C√ÅC BI·∫æN & LOGIC CHO T√çNH NƒÇNG L∆ØU TR·ªÆ (INDEXEDDB) ---
        let currentPromptText = "";
        let currentResponseText = "";
        let currentRepoIndex = ""; // Bi·∫øn l∆∞u tr·ªØ Page Index (Ng·ªØ c·∫£nh c·ªßa Repo)
        let activeTemplateType = "custom"; // Bi·∫øn theo d√µi lo·∫°i Template ƒëang d√πng

        window.clearRepoIndex = function() {
            currentRepoIndex = "";
            document.getElementById('repoContextBadge').classList.add('hidden');
            updateStatus('info-text', "ƒê√£ x√≥a b·ªô nh·ªõ v·ªÅ d·ª± √°n hi·ªán t·∫°i.");
            document.getElementById('quickActions').classList.add('hidden');
        };

        const saveLessonBtn = document.getElementById('saveLessonBtn');
        const responseContent = document.getElementById('responseContent');
        const historyList = document.getElementById('historyList');
        const quickActions = document.getElementById('quickActions');

        // --- LOGIC CUSTOM MODAL ---
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showCustomConfirm(message, onConfirm) {
            document.getElementById('confirmMessage').innerText = message;
            const overlay = document.getElementById('confirmModal');
            const yesBtn = document.getElementById('confirmYesBtn');
            
            overlay.classList.add('show');
            yesBtn.onclick = function() {
                closeModal('confirmModal');
                onConfirm();
            };
        }

        function showCustomPrompt(title, defaultVal, onConfirm) {
            document.getElementById('promptTitle').innerText = title;
            const inputField = document.getElementById('promptInputVal');
            const overlay = document.getElementById('promptModal');
            const yesBtn = document.getElementById('promptYesBtn');
            
            inputField.value = defaultVal;
            overlay.classList.add('show');
            inputField.focus();
            
            yesBtn.onclick = function() {
                closeModal('promptModal');
                onConfirm(inputField.value);
            };
            
            inputField.onkeydown = function(e) {
                if (e.key === 'Enter') yesBtn.click();
            }
        }

        const dbName = "AITutorDB";
        const dbVersion = 1;
        let db;

        function initDB() {
            const request = indexedDB.open(dbName, dbVersion);
            request.onerror = (event) => console.error("L·ªói m·ªü IndexedDB", event);
            request.onsuccess = (event) => {
                db = event.target.result;
                loadHistory(); // T·∫£i l·ªãch s·ª≠ ngay khi m·ªü web
            };
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                const objectStore = db.createObjectStore("lessons", { keyPath: "id", autoIncrement: true });
                objectStore.createIndex("timestamp", "timestamp", { unique: false });
            };
        }
        initDB();

        function loadHistory() {
            if (!db) return;
            const transaction = db.transaction(["lessons"], "readonly");
            const store = transaction.objectStore("lessons");
            const request = store.getAll();
            
            request.onsuccess = () => {
                const lessons = request.result.sort((a, b) => b.timestamp - a.timestamp); // X·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu
                historyList.innerHTML = "";
                if (lessons.length === 0) {
                    historyList.innerHTML = '<div style="font-size: 13px; color: #57606a;">Ch∆∞a c√≥ b√†i h·ªçc n√†o ƒë∆∞·ª£c l∆∞u.</div>';
                    return;
                }
                
                lessons.forEach(lesson => {
                    const dateStr = new Date(lesson.timestamp).toLocaleString('vi-VN');
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div style="overflow: hidden; flex-grow: 1;" onclick="viewLesson(${lesson.id})">
                            <div class="history-title">${lesson.title}</div>
                            <div class="history-date">${dateStr}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteLesson(${lesson.id}, event)" title="X√≥a b√†i n√†y">üóëÔ∏è</button>
                    `;
                    historyList.appendChild(item);
                });
            };
        }

        window.viewLesson = function(id) {
            const transaction = db.transaction(["lessons"], "readonly");
            const store = transaction.objectStore("lessons");
            const request = store.get(id);
            request.onsuccess = () => {
                if(request.result) {
                    const lesson = request.result;
                    promptInput.value = lesson.prompt;
                    responseContent.innerHTML = marked.parse(lesson.content);
                    currentPromptText = lesson.prompt;
                    currentResponseText = lesson.content;
                    saveLessonBtn.classList.add('hidden'); // ·∫®n n√∫t l∆∞u v√¨ ƒë√¢y l√† b√†i c≈©
                    updateStatus('info-text', `ƒêang xem l·∫°i b√†i h·ªçc: ${lesson.title}`);
                    
                    // ƒê√≥ng sidebar tr√™n mobile
                    if(window.innerWidth <= 850 && document.getElementById('sidebar').classList.contains('open')) {
                        document.getElementById('sidebar').classList.remove('open');
                        document.getElementById('sidebarOverlay').classList.remove('show');
                    }
                }
            };
        };

        window.deleteLesson = function(id, event) {
            event.stopPropagation();
            
            // D√πng Custom Confirm Modal thay cho confirm()
            showCustomConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc n√†y kh·ªèi l·ªãch s·ª≠?", () => {
                const transaction = db.transaction(["lessons"], "readwrite");
                const store = transaction.objectStore("lessons");
                const request = store.delete(id);
                request.onsuccess = () => {
                    loadHistory();
                    updateStatus('success-text', "ƒê√£ x√≥a b√†i h·ªçc th√†nh c√¥ng.");
                };
            });
        };

        if (saveLessonBtn) {
            saveLessonBtn.addEventListener('click', () => {
                if (!db || !currentResponseText) return;
                
                // G·ª£i √Ω t√™n t·ª± ƒë·ªông t·ª´ n·ªôi dung l·ªùi nh·∫Øc
                let defaultTitle = currentPromptText.split('\n')[0].substring(0, 35) + "...";
                
                // D√πng Custom Prompt Modal thay cho prompt()
                showCustomPrompt("Nh·∫≠p t√™n ƒë·ªÉ l∆∞u b√†i h·ªçc n√†y:", defaultTitle, (title) => {
                    if (title.trim() === "") title = defaultTitle;

                    const transaction = db.transaction(["lessons"], "readwrite");
                    const store = transaction.objectStore("lessons");
                    const lesson = {
                        title: title,
                        prompt: currentPromptText,
                        content: currentResponseText,
                        timestamp: new Date().getTime()
                    };
                    
                    const request = store.add(lesson);
                    request.onsuccess = () => {
                        updateStatus('success-text', "ƒê√£ l∆∞u v√†o b·ªô nh·ªõ tr√¨nh duy·ªát!");
                        saveLessonBtn.classList.add('hidden');
                        loadHistory();
                    };
                });
            });
        }

        // Logic thao t√°c nhanh (Quick Actions)
        document.getElementById('btnNextStep').addEventListener('click', () => {
            promptInput.value = "T√¥i ƒë√£ ho√†n th√†nh b∆∞·ªõc v·ª´a r·ªìi. H√£y ti·∫øp t·ª•c h∆∞·ªõng d·∫´n t√¥i b∆∞·ªõc ti·∫øp theo.";
            sendPromptButton.click();
        });

        document.getElementById('btnGotBug').addEventListener('click', () => {
            promptInput.value = "T√¥i g·∫∑p l·ªói ·ªü b∆∞·ªõc n√†y. L√Ω do c√≥ th·ªÉ l√† g√¨ v√† l√†m sao ƒë·ªÉ ki·ªÉm tra/kh·∫Øc ph·ª•c? ƒê√¢y l√† m√£ l·ªói t√¥i th·∫•y:\n[D√ÅN M√É L·ªñI V√ÄO ƒê√ÇY]";
            promptInput.focus();
            // N·∫øu tr√™n Mobile, t·ª± m·ªü l·∫°i sidebar ƒë·ªÉ g√µ l·ªói
            if(window.innerWidth <= 850 && !document.getElementById('sidebar').classList.contains('open')) {
                toggleSidebar();
            }
        });

        // Logic ·∫©n hi·ªán Sidebar cho Mobile
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        function updateStatus(type, message) {
            statusMessage.className = `status-message ${type}`;
            statusMessage.textContent = message;
            if (type === 'info-text') {
                statusMessage.innerHTML = message; // Cho ph√©p th·∫ª <br> ho·∫°t ƒë·ªông
            }
        }

        updateStatus('info-text', "Firebase App ƒë√£ kh·ªüi t·∫°o.<br>ƒêang ch·ªù m√¥ h√¨nh AI...");

        // C·∫•u h√¨nh Marked.js t√≠ch h·ª£p v·ªõi Highlight.js ƒë·ªÉ t√¥ m√†u code
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        const systemPrompt = `You are an AI Technical Tutor.

Your task is to turn any GitHub repository into a complete, beginner-friendly tutorial.

Assume the user is a beginner developer.
Never skip steps.
Never assume prior knowledge.

For every repository, always follow this structure:

1. Explain what problem this repository solves.
2. Explain the big picture architecture.
3. Show the file structure and which file to start with.
4. Explain the execution flow from input to output.
5. Give step-by-step terminal commands to run locally.
6. Explain each command and what it does.
7. Explain how to modify or extend the project.
8. Explain how to deploy (if applicable).

Rules:
- Use simple language.
- Explain before showing code.
- When showing code, explain what each part does.
- Never say "just run this".
- Teach like a real instructor, not like a chatbot.`;

        let model;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { 
                model: "gemini-2.5-flash",
                systemInstruction: systemPrompt
            });
            console.log("Generative Model instance created with model 'gemini-2.5-flash' and System Instruction!");
            updateStatus('success-text', "AI Tutor ƒë√£ s·∫µn s√†ng. H√£y ch·ªçn m·ªôt m·∫´u b√™n tr√™n.");
        } catch (e) {
            console.error("L·ªói khi kh·ªüi t·∫°o AI Model:", e);
            updateStatus('error-text', `L·ªói kh·ªüi t·∫°o AI Model: ${e.message}.<br>Ki·ªÉm tra Console (F12).`);
        }

        const templates = {
            explain: "H√£y ƒë√≥ng vai m·ªôt chuy√™n gia l·∫≠p tr√¨nh. ƒê·ªçc repository d∆∞·ªõi ƒë√¢y v√† t·∫°o ra m·ªôt b·∫£n t√≥m t·∫Øt ki·∫øn tr√∫c d·ª± √°n, lu·ªìng ho·∫°t ƒë·ªông ch√≠nh v√† c√°c file quan tr·ªçng. Gi·∫£i th√≠ch cho t√¥i hi·ªÉu nh∆∞ m·ªôt ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu.\n\n[D√ÅN LINK GITHUB HO·∫∂C M√É NGU·ªíN V√ÄO ƒê√ÇY]",
            tutor: "B√¢y gi·ªù h√£y d·∫°y t√¥i th·ª±c h√†nh d·ª± √°n tr√™n t·ª´ng b∆∞·ªõc m·ªôt.\nSau m·ªói b∆∞·ªõc, h√£y ƒë·ª£i t√¥i x√°c nh·∫≠n tr∆∞·ªõc khi ti·∫øp t·ª•c.\nN·∫øu t√¥i g·∫∑p l·ªói, h√£y gi√∫p t√¥i s·ª≠a (debug).",
            debug: "T√¥i nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o l·ªói n√†y trong qu√° tr√¨nh l√†m. H√£y gi·∫£i th√≠ch b·∫±ng ng√¥n ng·ªØ ƒë∆°n gi·∫£n t·∫°i sao l·∫°i b·ªã l·ªói v√† c√°ch kh·∫Øc ph·ª•c.\n[D√ÅN LOG L·ªñI V√ÄO ƒê√ÇY]",
            customize: "T√¥i mu·ªën t√πy ch·ªânh d·ª± √°n n√†y cho m·ª•c ƒë√≠ch c√° nh√¢n c·ªßa m√¨nh:\n[ƒêI·ªÄN M·ª§C TI√äU C·ª¶A B·∫†N V√ÄO ƒê√ÇY]\n\nH√£y gi·∫£i th√≠ch nh·ªØng g√¨ t√¥i c·∫ßn thay ƒë·ªïi trong m√£ ngu·ªìn.",
            deploy: "H√£y h∆∞·ªõng d·∫´n t√¥i c√°ch tri·ªÉn khai (deploy) d·ª± √°n n√†y l√™n m·∫°ng.\nC·ª© gi·∫£ ƒë·ªãnh r·∫±ng t√¥i ch∆∞a t·ª´ng deploy b·∫•t c·ª© th·ª© g√¨ tr∆∞·ªõc ƒë√¢y.\nH√£y gi·∫£i th√≠ch c·∫∑n k·∫Ω t·ª´ng b∆∞·ªõc."
        };

        window.setTemplate = function(type) {
            activeTemplateType = type; // Ghi nh·∫≠n lo·∫°i template ng∆∞·ªùi d√πng v·ª´a b·∫•m
            promptInput.value = templates[type];
            promptInput.focus();
            
            // N·∫øu ƒëang d√πng Mobile, t·ª± ƒë·ªông ƒë√≥ng sidebar sau khi ch·ªçn template ƒë·ªÉ xem tr∆∞·ªõc
            if(window.innerWidth <= 850 && sidebar.classList.contains('open')) {
                // toggleSidebar(); // C√≥ th·ªÉ m·ªü comment d√≤ng n√†y n·∫øu mu·ªën t·ª± ƒë√≥ng
            }
        };

        async function callGeminiAPI() {
            if (!model) {
                updateStatus('error-text', "M√¥ h√¨nh AI ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o. Vui l√≤ng th·ª≠ t·∫£i l·∫°i trang.");
                return;
            }

            const promptText = promptInput.value.trim();
            if (!promptText) {
                updateStatus('error-text', "Vui l√≤ng nh·∫≠p l·ªùi nh·∫Øc ho·∫∑c d√°n link tr∆∞·ªõc!");
                return;
            }

            updateStatus('info-text', "ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn Gemini...");
            
            // Loading Animation
            saveLessonBtn.classList.add('hidden');
            quickActions.classList.add('hidden'); // ·∫®n n√∫t thao t√°c nhanh khi ƒëang load
            responseContent.innerHTML = '<div class="large-spinner"></div><div>ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...</div>';
            responseContainer.classList.add('loading');

            buttonText.textContent = 'ƒêang x·ª≠ l√Ω...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            // T·ª± ƒë·ªông ƒë√≥ng sidebar tr√™n mobile khi b·∫Øt ƒë·∫ßu ch·∫°y
            if(window.innerWidth <= 850 && sidebar.classList.contains('open')) {
                toggleSidebar();
            }

            // --- X·ª¨ L√ù K·∫∏P PAGE INDEX V√ÄO L·ªúI NH·∫ÆC ---
            let finalPrompt = promptText;
            // N·∫øu ƒë√£ c√≥ Index v√† ng∆∞·ªùi d√πng kh√¥ng ph·∫£i ƒëang mu·ªën t·∫°o Index m·ªõi
            if (currentRepoIndex !== "" && activeTemplateType !== 'explain') {
                finalPrompt = `[NG·ªÆ C·∫¢NH D·ª∞ √ÅN T·ª™ PAGE INDEX ƒê√É L∆ØU]:\n${currentRepoIndex}\n\n`;
                
                // [N√ÇNG C·∫§P B·ªò NH·ªö]: Th√™m ƒëo·∫°n ph·∫£n h·ªìi g·∫ßn nh·∫•t ƒë·ªÉ AI bi·∫øt m√¨nh v·ª´a d·∫°y ƒë·∫øn b∆∞·ªõc n√†o
                if (currentResponseText !== "") {
                    finalPrompt += `[B∆Ø·ªöC B·∫†N V·ª™A H∆Ø·ªöNG D·∫™N ·ªû TR∆Ø·ªöC ƒê√ì]:\n${currentResponseText}\n\n`;
                }

                finalPrompt += `---\n[Y√äU C·∫¶U M·ªöI C·ª¶A T√îI]:\n${promptText}`;
            }

            try {
                // G·ª≠i finalPrompt thay v√¨ promptText th√¥
                const result = await model.generateContent(finalPrompt);
                const response = result.response;
                const text = response.text();

                // L∆∞u tr·ªØ v√†o bi·∫øn t·∫°m ƒë·ªÉ d√πng khi ng∆∞·ªùi d√πng ·∫•n n√∫t "L∆∞u b√†i h·ªçc"
                currentPromptText = promptText; 
                currentResponseText = text;

                // N·∫øu ƒëang ch·∫°y l·ªánh "Gi·∫£i th√≠ch Repo", l∆∞u k·∫øt qu·∫£ l√†m Page Index
                if (activeTemplateType === 'explain') {
                    currentRepoIndex = text;
                    document.getElementById('repoContextBadge').classList.remove('hidden');
                }

                // Render Markdown sang HTML
                responseContent.innerHTML = marked.parse(text);
                responseContainer.classList.remove('loading');
                
                // Hi·ªÉn th·ªã th√¥ng b√°o t∆∞∆°ng ·ª©ng
                if (activeTemplateType === 'explain') {
                    updateStatus('success-text', "ƒê√£ nh·∫≠n ph·∫£n h·ªìi. üìå H·ªá th·ªëng ƒë√£ GHI NH·ªö c·∫•u tr√∫c d·ª± √°n n√†y cho c√°c c√¢u h·ªèi sau!");
                } else {
                    updateStatus('success-text', "ƒê√£ nh·∫≠n ph·∫£n h·ªìi th√†nh c√¥ng.");
                }

                // Tr·∫£ activeTemplateType v·ªÅ custom ƒë·ªÉ n·∫øu chat t·ª± do v·∫´n d√πng Index
                activeTemplateType = "custom";
                
                // Hi·ªán n√∫t Save v√† Quick Actions
                saveLessonBtn.classList.remove('hidden');
                quickActions.classList.remove('hidden');
                
                // Cu·ªôn l√™n ƒë·∫ßu k·∫øt qu·∫£ m·ªõi
                document.getElementById('main-content').scrollTop = 0;

            } catch (error) {
                console.error("L·ªói khi g·ªçi Gemini API:", error);
                responseContent.innerHTML = `<h3 style="color:#cf222e;">ƒê√£ x·∫£y ra l·ªói:</h3><p>${error.message}</p><p>Vui l√≤ng ki·ªÉm tra Console (F12) ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.</p>`;
                responseContainer.classList.remove('loading');
                updateStatus('error-text', `L·ªói: ${error.message}.`);
            } finally {
                buttonText.textContent = 'G·ª≠i t·ªõi Gemini';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
            }
        }

        if (sendPromptButton) {
            sendPromptButton.addEventListener("click", callGeminiAPI);
        }
    </script>
</body>
</html>
